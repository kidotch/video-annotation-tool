<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Video Annotation Tool</title>
<style>
/* ãƒšãƒ¼ã‚¸æ‹¡å¤§ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒã‚¦ãƒ³ã‚¹ãƒ»ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é˜²æ­¢ */
html, body {
  overflow: hidden;
  overscroll-behavior: none;
  -webkit-overflow-scrolling: auto;
  touch-action: none;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
  position: fixed;
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒŠ */
#container {
  width: 100%;
  height: 100%;
  overflow-y: auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
  touch-action: pan-y;
  padding: 16px;
  box-sizing: border-box;
}

body { font-family: system-ui; }

/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯é¸æŠå¯èƒ½ã« */
#timeDisplay, input, textarea, td { -webkit-user-select: text; user-select: text; }
video { width: 100%; max-height: 40vh; background: #333; }
button { font-size: 16px; padding: 10px 14px; margin: 4px; }

/* ã‚·ãƒ¼ã‚¯ãƒãƒ¼ */
#seekContainer { margin: 12px 0; }
#seekBar { width: 100%; height: 8px; cursor: pointer; }
#timeDisplay { font-family: monospace; font-size: 16px; margin: 8px 0; }
#playbackControls { margin: 8px 0; display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
#playbackControls button { font-size: 14px; padding: 8px 12px; }
#speedDisplay { font-family: monospace; font-size: 14px; min-width: 40px; text-align: center; }
#fineSeek { margin: 8px 0; display: flex; flex-wrap: nowrap; gap: 4px; }
#fineSeek button { font-size: 12px; padding: 6px 8px; flex-shrink: 0; }
#volumeControls { margin: 8px 0; display: flex; align-items: center; gap: 8px; }
#volumeControls button { font-size: 14px; padding: 8px 12px; }
#volumeBar { width: 120px; height: 8px; cursor: pointer; }
#volumeDisplay { font-family: monospace; font-size: 14px; min-width: 40px; }
#timestampBtn { background: #4CAF50; color: white; border: none; border-radius: 4px; }
#timestampBtn:active { background: #388E3C; }
.copied { background: #2196F3 !important; }

/* ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰ */
#fineModeBtn { background: #9E9E9E; color: white; border: none; border-radius: 4px; }
#fineModeBtn.active { background: #FF5722; }
#fineModeInfo { font-size: 12px; color: #666; margin-top: 4px; }
#fineModeInfo.active { color: #FF5722; font-weight: bold; }

/* ãƒœã‚¿ãƒ³ã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ é˜²æ­¢ */
button, input { touch-action: manipulation; }

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.section { margin: 16px 0; padding: 12px; background: #f5f5f5; border-radius: 8px; }
.section h4 { margin: 0 0 12px 0; }

/* ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« */
#annotationTable { width: 100%; border-collapse: collapse; font-size: 14px; }
#annotationTable th, #annotationTable td { border: 1px solid #ddd; padding: 8px; text-align: left; }
#annotationTable th { background: #e0e0e0; }
#annotationTable tr:hover { background: #f0f0f0; }
#annotationTable .query-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
#tableContainer { max-height: 300px; overflow-y: auto; }

/* ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  */
#editForm { display: grid; gap: 8px; }
#editForm label { font-weight: bold; font-size: 14px; }
#editForm input, #editForm textarea, #editForm select { font-size: 16px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
#editForm textarea { resize: vertical; min-height: 60px; }

/* ã‚ªãƒ¼ãƒˆã‚µã‚¸ã‚§ã‚¹ãƒˆ */
.query-input-container { position: relative; }
#suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ccc;
  border-top: none;
  border-radius: 0 0 4px 4px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  display: none;
}
#suggestions.show { display: block; }
.suggestion-item {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}
.suggestion-item:hover, .suggestion-item.selected {
  background: #e3f2fd;
}
.suggestion-item:last-child { border-bottom: none; }
.form-row { display: flex; align-items: center; gap: 8px; }
.form-row input { flex: 1; }
.form-row button { flex-shrink: 0; }

/* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
.btn-primary { background: #2196F3; color: white; border: none; border-radius: 4px; }
.btn-primary:active { background: #1976D2; }
.btn-danger { background: #f44336; color: white; border: none; border-radius: 4px; }
.btn-danger:active { background: #d32f2f; }
.btn-secondary { background: #9E9E9E; color: white; border: none; border-radius: 4px; }
.btn-small { font-size: 12px; padding: 6px 10px; }

/* ç·¨é›†ä¸­ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
#annotationTable tr.editing { background: #fff3e0 !important; }

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
#status { font-size: 14px; color: #666; margin: 8px 0; }
#status.error { color: #f44336; }
#status.success { color: #4CAF50; }
</style>
</head>
<body>
<div id="container">

<h3>Video Annotation Tool</h3>

<!-- å‹•ç”»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="section">
  <h4>å‹•ç”»</h4>
  <p><input type="file" id="file" accept="video/*"></p>
  <video id="video" playsinline muted webkit-playsinline></video>

  <div id="seekContainer">
    <input type="range" id="seekBar" min="0" max="100" step="0.01" value="0">
    <div id="timeDisplay">00:00.000 / 00:00.000</div>
    <div id="playbackControls">
      <button id="btnRewind" class="btn-secondary">âª</button>
      <button id="btnPlay" class="btn-primary">â–¶</button>
      <button id="btnPause" class="btn-secondary">â¸</button>
      <button id="btnFastFwd" class="btn-secondary">â©</button>
      <span id="speedDisplay">1.0x</span>
    </div>
    <div id="fineSeek">
      <button id="seekBack10">-10s</button>
      <button id="seekBack1">-1s</button>
      <button id="seekBackFrame">-0.1s</button>
      <button id="seekFwdFrame">+0.1s</button>
      <button id="seekFwd1">+1s</button>
      <button id="seekFwd10">+10s</button>
    </div>
    <div id="volumeControls">
      <button id="muteBtn">ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ</button>
      <input type="range" id="volumeBar" min="0" max="100" value="0">
      <span id="volumeDisplay">0%</span>
    </div>
    <p>
      <button id="fineModeBtn">ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰</button>
      <button id="timestampBtn">ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚³ãƒ”ãƒ¼</button>
      <span id="copyFeedback"></span>
    </p>
    <div id="fineModeInfo">ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰: ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã®å‹•ããŒ10å€ç´°ã‹ããªã‚Šã¾ã™</div>
  </div>
</div>

<!-- CSVãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ -->
<div class="section">
  <h4>CSVãƒ•ã‚¡ã‚¤ãƒ«</h4>
  <p>
    <button id="loadCsvBtn" class="btn-primary">CSVã‚’èª­ã¿è¾¼ã¿</button>
    <button id="openLocalCsvBtn" class="btn-primary">ãƒ­ãƒ¼ã‚«ãƒ«CSVã‚’é–‹ã</button>
    <button id="downloadCsvBtn" class="btn-primary">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <button id="saveCsvBtn" class="btn-primary" disabled>ä¸Šæ›¸ãä¿å­˜</button>
  </p>
  <div id="status"></div>
</div>

<!-- ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="section">
  <h4 id="formTitle">æ–°è¦ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</h4>
  <div id="editForm">
    <input type="hidden" id="editId" value="">
    <div>
      <label>video_id</label>
      <input type="text" id="editVideoId" readonly style="background: #e0e0e0;">
    </div>
    <div>
      <label>start</label>
      <div class="form-row">
        <input type="number" id="editStart" step="0.1" placeholder="0.0">
        <button type="button" id="setStartBtn" class="btn-secondary btn-small">ç¾åœ¨æ™‚åˆ»</button>
      </div>
    </div>
    <div>
      <label>end</label>
      <div class="form-row">
        <input type="number" id="editEnd" step="0.1" placeholder="0.0">
        <button type="button" id="setEndBtn" class="btn-secondary btn-small">ç¾åœ¨æ™‚åˆ»</button>
      </div>
    </div>
    <div class="query-input-container">
      <label>query</label>
      <textarea id="editQuery" placeholder="The nurse performs..."></textarea>
      <div id="suggestions"></div>
    </div>
    <div>
      <button id="saveBtn" class="btn-primary">è¿½åŠ </button>
      <button id="clearFormBtn" class="btn-secondary">ã‚¯ãƒªã‚¢</button>
    </div>
  </div>
</div>

<!-- ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ -->
<div class="section">
  <h4>ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ (<span id="annotationCount">0</span>ä»¶)</h4>
  <div id="tableContainer">
    <table id="annotationTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>video_id</th>
          <th>start</th>
          <th>end</th>
          <th>query</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="annotationBody">
      </tbody>
    </table>
  </div>
</div>

<script>
// ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
var annotations = [];
var editingId = null;
var currentVideoId = "";
var csvFileHandle = null; // File System Access APIç”¨

// ===== DOMè¦ç´  =====
var v = document.getElementById("video");
var fileInput = document.getElementById("file");
var seekBar = document.getElementById("seekBar");
var timeDisplay = document.getElementById("timeDisplay");

// ===== ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ é˜²æ­¢ =====
document.addEventListener("touchstart", function(e) {
  // videoè¦ç´ å†…ã®ãƒãƒ«ãƒã‚¿ãƒƒãƒã¯è¨±å¯ï¼ˆãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ãªã©ï¼‰
  if (e.target.tagName === "VIDEO" || e.target.closest("video")) {
    return;
  }
  if (e.touches.length > 1) e.preventDefault();
}, { passive: false });

document.addEventListener("gesturestart", function(e) {
  // videoè¦ç´ å†…ã®ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã¯è¨±å¯
  if (e.target.tagName === "VIDEO" || e.target.closest("video")) {
    return;
  }
  e.preventDefault();
}, { passive: false });

// ===== ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é˜²æ­¢ =====
var container = document.getElementById("container");
var lastY = 0;

container.addEventListener("touchstart", function(e) {
  lastY = e.touches[0].clientY;
}, { passive: true });

container.addEventListener("touchmove", function(e) {
  // videoè¦ç´ ã‚„ãã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å†…ã®ã‚¿ãƒƒãƒã¯ç„¡è¦–
  var target = e.target;
  if (target.tagName === "VIDEO" || target.closest("video")) {
    return;
  }

  var y = e.touches[0].clientY;
  var scrollTop = container.scrollTop;
  if (scrollTop <= 0 && y > lastY) {
    e.preventDefault();
  }
  lastY = y;
}, { passive: false });

// ===== å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ =====
fileInput.onchange = function(e) {
  var files = e.target.files;
  if (!files || files.length === 0) return;
  var url = URL.createObjectURL(files[0]);
  v.src = url;

  // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰video_idã‚’æŠ½å‡ºï¼ˆæ‹¡å¼µå­ã‚’é™¤ãï¼‰
  var filename = files[0].name;
  currentVideoId = filename.replace(/\.[^.]+$/, "");
  document.getElementById("editVideoId").value = currentVideoId;
};

// ===== æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ =====
function formatTime(sec) {
  if (isNaN(sec) || !isFinite(sec)) return "0.000";
  return sec.toFixed(3);
}

function formatTimeForCopy(sec) {
  if (isNaN(sec) || !isFinite(sec)) return "0.0";
  return sec.toFixed(1);
}

// ===== ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰ =====
var fineMode = false;
var fineStartTime = 0;
var fineStartValue = 0;
var fineSensitivity = 10;

function updateTimeDisplay() {
  var current = formatTime(v.currentTime);
  var total = formatTime(v.duration);
  timeDisplay.textContent = current + " / " + total;
  if (v.duration > 0) {
    seekBar.value = (v.currentTime / v.duration) * 100;
  }
}

v.ontimeupdate = updateTimeDisplay;
v.ondurationchange = updateTimeDisplay;

// ===== ã‚·ãƒ¼ã‚¯ãƒãƒ¼æ“ä½œ =====
seekBar.addEventListener("touchstart", function() {
  if (fineMode && v.duration > 0) {
    fineStartTime = v.currentTime;
    fineStartValue = parseFloat(seekBar.value);
  }
});

seekBar.addEventListener("mousedown", function() {
  if (fineMode && v.duration > 0) {
    fineStartTime = v.currentTime;
    fineStartValue = parseFloat(seekBar.value);
  }
});

seekBar.oninput = function() {
  if (v.duration > 0) {
    if (fineMode) {
      var delta = (parseFloat(seekBar.value) - fineStartValue) / fineSensitivity;
      var newPercent = (fineStartTime / v.duration) * 100 + delta;
      newPercent = Math.max(0, Math.min(100, newPercent));
      v.currentTime = (newPercent / 100) * v.duration;
    } else {
      v.currentTime = (seekBar.value / 100) * v.duration;
    }
    updateTimeDisplay();
  }
};

// ===== ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ =====
document.getElementById("fineModeBtn").onclick = function() {
  fineMode = !fineMode;
  var btn = document.getElementById("fineModeBtn");
  var info = document.getElementById("fineModeInfo");
  if (fineMode) {
    btn.classList.add("active");
    btn.textContent = "ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰ ON";
    info.classList.add("active");
    info.textContent = "ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰ ON: ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã®å‹•ããŒ10å€ç´°ã‹ããªã‚Šã¾ã™";
  } else {
    btn.classList.remove("active");
    btn.textContent = "ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰";
    info.classList.remove("active");
    info.textContent = "ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰: ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã®å‹•ããŒ10å€ç´°ã‹ããªã‚Šã¾ã™";
  }
};

// ===== ç´°ã‹ã„ã‚·ãƒ¼ã‚¯ãƒœã‚¿ãƒ³ =====
function seekBy(sec) {
  v.currentTime = Math.max(0, Math.min(v.duration || 0, v.currentTime + sec));
  updateTimeDisplay();
}

document.getElementById("seekBack10").onclick = function() { seekBy(-10); };
document.getElementById("seekBack1").onclick = function() { seekBy(-1); };
document.getElementById("seekBackFrame").onclick = function() { seekBy(-0.1); };
document.getElementById("seekFwdFrame").onclick = function() { seekBy(0.1); };
document.getElementById("seekFwd1").onclick = function() { seekBy(1); };
document.getElementById("seekFwd10").onclick = function() { seekBy(10); };

// ===== éŸ³é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« =====
var volumeBar = document.getElementById("volumeBar");
var volumeDisplay = document.getElementById("volumeDisplay");
var muteBtn = document.getElementById("muteBtn");

function updateVolumeDisplay() {
  var vol = Math.round(v.volume * 100);
  volumeBar.value = vol;
  volumeDisplay.textContent = vol + "%";
  if (v.muted || v.volume === 0) {
    muteBtn.textContent = "ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ";
  } else {
    muteBtn.textContent = "ğŸ”Š éŸ³ã‚ã‚Š";
  }
}

volumeBar.oninput = function() {
  v.volume = volumeBar.value / 100;
  v.muted = false;
  updateVolumeDisplay();
};

muteBtn.onclick = function() {
  if (v.muted) {
    v.muted = false;
    if (v.volume === 0) v.volume = 0.5;
  } else {
    v.muted = true;
  }
  updateVolumeDisplay();
};

// åˆæœŸçŠ¶æ…‹ã§ãƒŸãƒ¥ãƒ¼ãƒˆãªã®ã§éŸ³é‡0ã§è¡¨ç¤º
updateVolumeDisplay();

// ===== å†ç”Ÿãƒ»åœæ­¢ãƒ»æ—©é€ã‚Šãƒ»å·»ãæˆ»ã— =====
var speedSteps = [1, 2, 4, 8];
var currentSpeedIndex = 0;
var playbackMode = "normal"; // "normal", "fastfwd", "rewind"
var rewindInterval = null;

function updateSpeedDisplay() {
  var speed = speedSteps[currentSpeedIndex];
  if (playbackMode === "rewind") {
    document.getElementById("speedDisplay").textContent = "â—€â—€ " + speed + "x";
  } else if (playbackMode === "fastfwd") {
    document.getElementById("speedDisplay").textContent = speed + "x â–¶â–¶";
  } else {
    document.getElementById("speedDisplay").textContent = speed + "x";
  }
}

function stopRewind() {
  if (rewindInterval) {
    clearInterval(rewindInterval);
    rewindInterval = null;
  }
}

function resetPlayback() {
  stopRewind();
  playbackMode = "normal";
  currentSpeedIndex = 0;
  v.playbackRate = 1;
  updateSpeedDisplay();
}

document.getElementById("btnPlay").onclick = function() {
  resetPlayback();
  v.play();
};

document.getElementById("btnPause").onclick = function() {
  resetPlayback();
  v.pause();
};

document.getElementById("btnFastFwd").onclick = function() {
  stopRewind();

  if (playbackMode === "fastfwd") {
    // æ¬¡ã®é€Ÿåº¦ã¸
    currentSpeedIndex++;
    if (currentSpeedIndex >= speedSteps.length) {
      // æœ€å¾Œã¾ã§è¡Œã£ãŸã‚‰é€šå¸¸ã«æˆ»ã‚‹
      resetPlayback();
      v.play();
      return;
    }
  } else {
    // æ—©é€ã‚Šãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
    playbackMode = "fastfwd";
    currentSpeedIndex = 1; // 2xã‹ã‚‰é–‹å§‹
  }

  v.playbackRate = speedSteps[currentSpeedIndex];
  v.play();
  updateSpeedDisplay();
};

document.getElementById("btnRewind").onclick = function() {
  if (playbackMode === "rewind") {
    // æ¬¡ã®é€Ÿåº¦ã¸
    currentSpeedIndex++;
    if (currentSpeedIndex >= speedSteps.length) {
      // æœ€å¾Œã¾ã§è¡Œã£ãŸã‚‰é€šå¸¸ã«æˆ»ã‚‹
      resetPlayback();
      v.play();
      return;
    }
  } else {
    // å·»ãæˆ»ã—ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
    stopRewind();
    playbackMode = "rewind";
    currentSpeedIndex = 1; // 2xã‹ã‚‰é–‹å§‹
    v.pause();
  }

  // å·»ãæˆ»ã—ã¯intervalã§å®Ÿè£…ï¼ˆè² ã®å†ç”Ÿé€Ÿåº¦ã¯éå¯¾å¿œã®ãŸã‚ï¼‰
  stopRewind();
  var speed = speedSteps[currentSpeedIndex];
  rewindInterval = setInterval(function() {
    v.currentTime = Math.max(0, v.currentTime - (speed * 0.1));
    updateTimeDisplay();
    if (v.currentTime <= 0) {
      resetPlayback();
    }
  }, 100);

  updateSpeedDisplay();
};

// ===== ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚³ãƒ”ãƒ¼ =====
document.getElementById("timestampBtn").onclick = function() {
  var timestamp = formatTimeForCopy(v.currentTime);
  var btn = document.getElementById("timestampBtn");
  var feedback = document.getElementById("copyFeedback");

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(timestamp).then(function() {
      btn.classList.add("copied");
      feedback.textContent = "ã‚³ãƒ”ãƒ¼: " + timestamp;
      setTimeout(function() {
        btn.classList.remove("copied");
        feedback.textContent = "";
      }, 2000);
    }).catch(function(err) {
      fallbackCopy(timestamp);
    });
  } else {
    fallbackCopy(timestamp);
  }
};

function fallbackCopy(text) {
  var ta = document.createElement("textarea");
  ta.value = text;
  ta.style.position = "fixed";
  ta.style.opacity = "0";
  document.body.appendChild(ta);
  ta.select();
  try {
    document.execCommand("copy");
    document.getElementById("copyFeedback").textContent = "ã‚³ãƒ”ãƒ¼: " + text;
  } catch(e) {
    document.getElementById("copyFeedback").textContent = "ã‚³ãƒ”ãƒ¼å¤±æ•—";
  }
  document.body.removeChild(ta);
  setTimeout(function() {
    document.getElementById("copyFeedback").textContent = "";
  }, 2000);
}

// ===== CSVèª­ã¿è¾¼ã¿ =====
document.getElementById("loadCsvBtn").onclick = function() {
  fetch("jichi2507_rule.csv?t=" + Date.now())
    .then(function(res) {
      if (!res.ok) throw new Error("CSV not found");
      return res.text();
    })
    .then(function(csv) {
      parseCsv(csv);
      showStatus("CSVèª­ã¿è¾¼ã¿å®Œäº† (" + annotations.length + "ä»¶)", "success");
    })
    .catch(function(err) {
      showStatus("CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message, "error");
    });
};

function parseCsv(csv) {
  var lines = csv.trim().split("\n");
  annotations = [];

  for (var i = 1; i < lines.length; i++) {
    var line = lines[i];
    if (!line.trim()) continue;

    // CSVãƒ‘ãƒ¼ã‚¹ï¼ˆã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
    var cols = parseCsvLine(line);
    if (cols.length >= 5) {
      annotations.push({
        id: parseInt(cols[0]) || i,
        video_id: cols[1],
        start: parseFloat(cols[2]) || 0,
        end: parseFloat(cols[3]) || 0,
        query: cols[4]
      });
    }
  }

  renderTable();
}

function parseCsvLine(line) {
  var result = [];
  var current = "";
  var inQuotes = false;

  for (var i = 0; i < line.length; i++) {
    var c = line[i];
    if (c === '"') {
      inQuotes = !inQuotes;
    } else if (c === ',' && !inQuotes) {
      result.push(current);
      current = "";
    } else {
      current += c;
    }
  }
  result.push(current);
  return result;
}

// ===== CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ =====
document.getElementById("downloadCsvBtn").onclick = function() {
  var csv = "id,video_id,start,end,query\n";

  for (var i = 0; i < annotations.length; i++) {
    var a = annotations[i];
    var query = a.query.replace(/"/g, '""');
    csv += a.id + "," + a.video_id + "," + a.start + "," + a.end + ',"' + query + '"\n';
  }

  var blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  var url = URL.createObjectURL(blob);
  var link = document.createElement("a");
  link.href = url;
  link.download = "jichi2507_rule.csv";
  link.click();
  URL.revokeObjectURL(url);

  showStatus("CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ", "success");
};

// ===== File System Access API: ãƒ­ãƒ¼ã‚«ãƒ«CSVã‚’é–‹ã =====
document.getElementById("openLocalCsvBtn").onclick = async function() {
  if (!window.showOpenFilePicker) {
    showStatus("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯File System Access APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼ˆChrome/Edgeã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼‰", "error");
    return;
  }

  try {
    var [handle] = await window.showOpenFilePicker({
      types: [{
        description: "CSV Files",
        accept: { "text/csv": [".csv"] }
      }]
    });
    csvFileHandle = handle;

    var file = await handle.getFile();
    var csv = await file.text();
    parseCsv(csv);

    document.getElementById("saveCsvBtn").disabled = false;
    showStatus("ãƒ­ãƒ¼ã‚«ãƒ«CSVèª­ã¿è¾¼ã¿å®Œäº† (" + annotations.length + "ä»¶) - ä¸Šæ›¸ãä¿å­˜ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ", "success");
  } catch (err) {
    if (err.name !== "AbortError") {
      showStatus("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ: " + err.message, "error");
    }
  }
};

// ===== File System Access API: ä¸Šæ›¸ãä¿å­˜ =====
document.getElementById("saveCsvBtn").onclick = async function() {
  if (!csvFileHandle) {
    showStatus("å…ˆã«ãƒ­ãƒ¼ã‚«ãƒ«CSVã‚’é–‹ã„ã¦ãã ã•ã„", "error");
    return;
  }

  try {
    var csv = "id,video_id,start,end,query\n";
    for (var i = 0; i < annotations.length; i++) {
      var a = annotations[i];
      var query = a.query.replace(/"/g, '""');
      csv += a.id + "," + a.video_id + "," + a.start + "," + a.end + ',"' + query + '"\n';
    }

    var writable = await csvFileHandle.createWritable();
    await writable.write(csv);
    await writable.close();

    showStatus("ä¸Šæ›¸ãä¿å­˜ã—ã¾ã—ãŸ", "success");
  } catch (err) {
    showStatus("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message, "error");
  }
};

// ===== ãƒ†ãƒ¼ãƒ–ãƒ«æç”» =====
function renderTable() {
  var tbody = document.getElementById("annotationBody");
  tbody.innerHTML = "";

  for (var i = 0; i < annotations.length; i++) {
    var a = annotations[i];
    var tr = document.createElement("tr");
    tr.dataset.id = a.id;

    if (editingId === a.id) {
      tr.classList.add("editing");
    }

    tr.innerHTML =
      "<td>" + a.id + "</td>" +
      "<td>" + escapeHtml(a.video_id) + "</td>" +
      "<td>" + a.start + "</td>" +
      "<td>" + a.end + "</td>" +
      '<td class="query-cell" title="' + escapeHtml(a.query) + '">' + escapeHtml(a.query) + "</td>" +
      "<td>" +
        '<button class="btn-primary btn-small edit-btn" data-id="' + a.id + '">ç·¨é›†</button> ' +
        '<button class="btn-danger btn-small delete-btn" data-id="' + a.id + '">å‰Šé™¤</button>' +
      "</td>";

    tbody.appendChild(tr);
  }

  document.getElementById("annotationCount").textContent = annotations.length;

  // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  var editBtns = document.querySelectorAll(".edit-btn");
  for (var j = 0; j < editBtns.length; j++) {
    editBtns[j].onclick = function() {
      editAnnotation(parseInt(this.dataset.id));
    };
  }

  var deleteBtns = document.querySelectorAll(".delete-btn");
  for (var k = 0; k < deleteBtns.length; k++) {
    deleteBtns[k].onclick = function() {
      deleteAnnotation(parseInt(this.dataset.id));
    };
  }
}

function escapeHtml(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

// ===== ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›† =====
function editAnnotation(id) {
  var a = annotations.find(function(x) { return x.id === id; });
  if (!a) return;

  editingId = id;
  document.getElementById("editId").value = id;
  document.getElementById("editVideoId").value = a.video_id;
  document.getElementById("editStart").value = a.start;
  document.getElementById("editEnd").value = a.end;
  document.getElementById("editQuery").value = a.query;

  document.getElementById("formTitle").textContent = "ç·¨é›†ä¸­: ID " + id;
  document.getElementById("saveBtn").textContent = "æ›´æ–°";

  renderTable();
}

// ===== ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å‰Šé™¤ =====
function deleteAnnotation(id) {
  if (!confirm("ID " + id + " ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  annotations = annotations.filter(function(x) { return x.id !== id; });

  if (editingId === id) {
    clearForm();
  }

  renderTable();
  showStatus("ID " + id + " ã‚’å‰Šé™¤ã—ã¾ã—ãŸ", "success");
}

// ===== ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢ =====
function clearForm() {
  editingId = null;
  document.getElementById("editId").value = "";
  document.getElementById("editVideoId").value = currentVideoId;
  document.getElementById("editStart").value = "";
  document.getElementById("editEnd").value = "";
  document.getElementById("editQuery").value = "";

  document.getElementById("formTitle").textContent = "æ–°è¦ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³";
  document.getElementById("saveBtn").textContent = "è¿½åŠ ";

  renderTable();
}

document.getElementById("clearFormBtn").onclick = clearForm;

// ===== ä¿å­˜ =====
document.getElementById("saveBtn").onclick = function() {
  var videoId = document.getElementById("editVideoId").value.trim();
  var start = parseFloat(document.getElementById("editStart").value) || 0;
  var end = parseFloat(document.getElementById("editEnd").value) || 0;
  var query = document.getElementById("editQuery").value.trim();

  if (!videoId) {
    showStatus("å‹•ç”»ã‚’é¸æŠã—ã¦ãã ã•ã„", "error");
    return;
  }

  if (editingId !== null) {
    // æ›´æ–°
    var a = annotations.find(function(x) { return x.id === editingId; });
    if (a) {
      a.video_id = videoId;
      a.start = start;
      a.end = end;
      a.query = query;
      showStatus("ID " + editingId + " ã‚’æ›´æ–°ã—ã¾ã—ãŸ", "success");
    }
  } else {
    // æ–°è¦è¿½åŠ 
    var maxId = 0;
    for (var i = 0; i < annotations.length; i++) {
      if (annotations[i].id > maxId) maxId = annotations[i].id;
    }

    annotations.push({
      id: maxId + 1,
      video_id: videoId,
      start: start,
      end: end,
      query: query
    });
    showStatus("ID " + (maxId + 1) + " ã‚’è¿½åŠ ã—ã¾ã—ãŸ", "success");
  }

  clearForm();
};

// ===== ç¾åœ¨æ™‚åˆ»ã‚»ãƒƒãƒˆ =====
document.getElementById("setStartBtn").onclick = function() {
  document.getElementById("editStart").value = formatTimeForCopy(v.currentTime);
};

document.getElementById("setEndBtn").onclick = function() {
  document.getElementById("editEnd").value = formatTimeForCopy(v.currentTime);
};

// ===== ã‚ªãƒ¼ãƒˆã‚µã‚¸ã‚§ã‚¹ãƒˆ =====
var queryInput = document.getElementById("editQuery");
var suggestionsBox = document.getElementById("suggestions");
var selectedIndex = -1;

function getUniqueQueries() {
  var seen = {};
  var unique = [];
  for (var i = 0; i < annotations.length; i++) {
    var q = annotations[i].query;
    if (q && !seen[q]) {
      seen[q] = true;
      unique.push(q);
    }
  }
  return unique.sort();
}

function showSuggestions(input) {
  var queries = getUniqueQueries();
  var inputLower = input.toLowerCase();
  var matches = [];

  if (input.length > 0) {
    for (var i = 0; i < queries.length; i++) {
      if (queries[i].toLowerCase().indexOf(inputLower) !== -1) {
        matches.push(queries[i]);
      }
    }
  }

  suggestionsBox.innerHTML = "";
  selectedIndex = -1;

  if (matches.length === 0) {
    suggestionsBox.classList.remove("show");
    return;
  }

  for (var j = 0; j < matches.length && j < 10; j++) {
    var div = document.createElement("div");
    div.className = "suggestion-item";
    div.textContent = matches[j];
    div.dataset.query = matches[j];
    div.onclick = function() {
      queryInput.value = this.dataset.query;
      suggestionsBox.classList.remove("show");
    };
    suggestionsBox.appendChild(div);
  }

  suggestionsBox.classList.add("show");
}

queryInput.addEventListener("input", function() {
  showSuggestions(this.value);
});

queryInput.addEventListener("focus", function() {
  if (this.value.length > 0) {
    showSuggestions(this.value);
  }
});

queryInput.addEventListener("keydown", function(e) {
  var items = suggestionsBox.querySelectorAll(".suggestion-item");
  if (items.length === 0) return;

  if (e.key === "ArrowDown") {
    e.preventDefault();
    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
    updateSelection(items);
  } else if (e.key === "ArrowUp") {
    e.preventDefault();
    selectedIndex = Math.max(selectedIndex - 1, -1);
    updateSelection(items);
  } else if (e.key === "Enter" && selectedIndex >= 0) {
    e.preventDefault();
    queryInput.value = items[selectedIndex].dataset.query;
    suggestionsBox.classList.remove("show");
  } else if (e.key === "Escape") {
    suggestionsBox.classList.remove("show");
  }
});

function updateSelection(items) {
  for (var i = 0; i < items.length; i++) {
    items[i].classList.remove("selected");
  }
  if (selectedIndex >= 0 && selectedIndex < items.length) {
    items[selectedIndex].classList.add("selected");
    items[selectedIndex].scrollIntoView({ block: "nearest" });
  }
}

document.addEventListener("click", function(e) {
  if (!suggestionsBox.contains(e.target) && e.target !== queryInput) {
    suggestionsBox.classList.remove("show");
  }
});

// ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º =====
function showStatus(msg, type) {
  var el = document.getElementById("status");
  el.textContent = msg;
  el.className = type || "";

  setTimeout(function() {
    el.textContent = "";
    el.className = "";
  }, 3000);
}

// ===== åˆæœŸåŒ–: CSVè‡ªå‹•èª­ã¿è¾¼ã¿ =====
window.onload = function() {
  fetch("jichi2507_rule.csv?t=" + Date.now())
    .then(function(res) {
      if (!res.ok) throw new Error("CSV not found");
      return res.text();
    })
    .then(function(csv) {
      parseCsv(csv);
      showStatus("CSVè‡ªå‹•èª­ã¿è¾¼ã¿å®Œäº† (" + annotations.length + "ä»¶)", "success");
    })
    .catch(function(err) {
      showStatus("CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚", "error");
    });
};
</script>

</div>
</body>
</html>
