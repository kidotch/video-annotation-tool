<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Video Annotation Tool</title>
<style>
/* ãƒ†ãƒ¼ãƒå¤‰æ•° */
:root {
  --bg-color: #ffffff;
  --bg-secondary: #f5f5f5;
  --bg-tertiary: #e0e0e0;
  --text-color: #333333;
  --text-secondary: #666666;
  --border-color: #dddddd;
  --input-bg: #ffffff;
  --input-border: #cccccc;
  --table-hover: #f0f0f0;
  --table-header: #e0e0e0;
  --suggestion-hover: #e3f2fd;
  --editing-row: #fff3e0;
  --selected-row: #e8f5e9;
  --video-bg: #333333;
}

[data-theme="dark"] {
  --bg-color: #1a1a1a;
  --bg-secondary: #2d2d2d;
  --bg-tertiary: #404040;
  --text-color: #e0e0e0;
  --text-secondary: #a0a0a0;
  --border-color: #444444;
  --input-bg: #333333;
  --input-border: #555555;
  --table-hover: #3a3a3a;
  --table-header: #404040;
  --suggestion-hover: #1e3a5f;
  --editing-row: #4a3a2a;
  --selected-row: #264a2c;
  --video-bg: #000000;
}

/* ãƒšãƒ¼ã‚¸æ‹¡å¤§ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒã‚¦ãƒ³ã‚¹ãƒ»ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é˜²æ­¢ */
html, body {
  overflow: hidden;
  overscroll-behavior: none;
  -webkit-overflow-scrolling: auto;
  touch-action: none;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
  position: fixed;
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  background: var(--bg-color);
  color: var(--text-color);
  transition: background 0.3s, color 0.3s;
}

/* ã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ï¼‰ */
#container {
  width: 100%;
  height: 100%;
  overflow: hidden;
  padding: 8px;
  box-sizing: border-box;
  background: var(--bg-color);
  display: flex;
  flex-direction: column;
}

body { font-family: system-ui; }

/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯é¸æŠå¯èƒ½ã« */
#timeDisplay, input, textarea, td { -webkit-user-select: text; user-select: text; }
video { width: 100%; background: var(--video-bg); }
button { font-size: 14px; padding: 6px 10px; margin: 2px; cursor: pointer; }

/* ã‚·ãƒ¼ã‚¯ãƒãƒ¼ */
#seekContainer { margin: 4px 0; }
#seekBar { width: 100%; height: 8px; cursor: pointer; }
.video-status-bar {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 4px 0;
  font-family: monospace;
  font-size: 14px;
  color: var(--text-secondary);
}
#timeDisplay { font-size: 16px; color: var(--text-color); }
#speedDisplay { min-width: 40px; text-align: center; }
#volumeDisplay { min-width: 40px; }

/* ç¾åœ¨ã®å‹•ç”»å */
.current-video-name {
  font-size: 18px;
  font-weight: bold;
  color: var(--text-color);
  margin-bottom: 6px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* å‹•ç”»é¸æŠ */
.video-selector {
  margin-top: 4px;
  position: relative;
}
.video-selector-row {
  display: flex;
  align-items: center;
  gap: 8px;
}
.video-selector-row input {
  flex: 1;
  font-size: 14px;
  padding: 6px 10px;
  border: 1px solid var(--input-border);
  border-radius: 4px;
  background: var(--input-bg);
  color: var(--text-color);
  box-sizing: border-box;
}
.video-nav-info {
  font-size: 12px;
  color: var(--text-secondary);
  white-space: nowrap;
}
.video-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--input-bg);
  border: 1px solid var(--input-border);
  border-top: none;
  border-radius: 0 0 4px 4px;
  max-height: 180px;
  overflow-y: auto;
  z-index: 200;
  display: none;
}
.video-suggestions.show { display: block; }
.video-suggestion-item {
  padding: 6px 10px;
  font-size: 13px;
  cursor: pointer;
  color: var(--text-color);
  border-bottom: 1px solid var(--border-color);
}
.video-suggestion-item:last-child { border-bottom: none; }
.video-suggestion-item:hover,
.video-suggestion-item.selected {
  background: var(--suggestion-hover);
}
.video-suggestion-item.active-video {
  color: #2196F3;
  font-weight: bold;
}
.copied { background: #2196F3 !important; }

/* ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰ */

/* ãƒœã‚¿ãƒ³ã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ é˜²æ­¢ */
button, input { touch-action: manipulation; }

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.section { margin: 4px 0; padding: 8px; background: var(--bg-secondary); border-radius: 8px; transition: background 0.3s; }
.section h4 { margin: 0 0 8px 0; color: var(--text-color); }
h3 { color: var(--text-color); }

/* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› */
input[type="file"] {
  color: var(--text-color);
}

/* ãƒ¬ãƒ³ã‚¸å…¥åŠ›ï¼ˆã‚·ãƒ¼ã‚¯ãƒãƒ¼ã€éŸ³é‡ãƒãƒ¼ï¼‰ */
input[type="range"] {
  accent-color: #2196F3;
}

/* ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« */
#annotationTable { width: 100%; border-collapse: collapse; font-size: 17px; }
#annotationTable th, #annotationTable td { border: 1px solid var(--border-color); padding: 10px; text-align: left; color: var(--text-color); }
#annotationTable th { background: var(--table-header); white-space: nowrap; }
#annotationTable tr:hover { background: var(--table-hover); }
#annotationTable .query-cell { white-space: normal; word-break: break-word; }
#annotationTable .time-cell { cursor: pointer; color: #2196F3; white-space: nowrap; }
#annotationTable .time-cell:hover { text-decoration: underline; background: var(--suggestion-hover); }
#tableContainer { max-height: 420px; overflow-y: auto; }

/* ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  */
#editForm { display: grid; gap: 4px; }
#editForm label { font-weight: bold; font-size: 13px; color: var(--text-color); }
#editForm input, #editForm textarea, #editForm select {
  font-size: 14px;
  padding: 4px 6px;
  border: 1px solid var(--input-border);
  border-radius: 4px;
  width: 100%;
  box-sizing: border-box;
  background: var(--input-bg);
  color: var(--text-color);
  transition: background 0.3s, border-color 0.3s, color 0.3s;
}
#editForm textarea { resize: vertical; min-height: 2.4em; height: 2.8em; }

/* ã‚ªãƒ¼ãƒˆã‚µã‚¸ã‚§ã‚¹ãƒˆ */
.query-input-container { position: relative; }

/* ã‚¤ãƒ³ã‚µãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
.insert-mode-indicator {
  font-size: 11px;
  font-weight: normal;
  color: var(--text-secondary);
  margin-left: 8px;
  padding: 2px 8px;
  border-radius: 4px;
  background: var(--bg-tertiary);
}

.insert-mode-indicator.active {
  background: #4CAF50;
  color: white;
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}
#suggestions {
  position: relative;
  left: 0;
  right: 0;
  background: var(--input-bg);
  border: 1px solid var(--input-border);
  border-top: none;
  border-radius: 0 0 4px 4px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  display: none;
}
#suggestions.show { display: block; }
.suggestion-item {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid var(--border-color);
  font-size: 14px;
  color: var(--text-color);
}
.suggestion-item.selected {
  background: var(--suggestion-hover);
}
.suggestion-item:last-child { border-bottom: none; }
.form-row { display: flex; align-items: center; gap: 8px; }
.form-row input { flex: 1; }
.form-row button { flex-shrink: 0; }

/* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
.btn-primary { background: #2196F3; color: white; border: none; border-radius: 4px; }
.btn-primary:active { background: #1976D2; }
.btn-danger { background: #f44336; color: white; border: none; border-radius: 4px; }
.btn-danger:active { background: #d32f2f; }
.btn-secondary { background: #9E9E9E; color: white; border: none; border-radius: 4px; }
.btn-small { font-size: 12px; padding: 6px 10px; }

/* ç·¨é›†ä¸­ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
#annotationTable tr.editing { background: var(--editing-row) !important; }
/* é¸æŠä¸­ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
#annotationTable tr.selected { background: var(--selected-row) !important; }
/* å†ç”Ÿä¸­ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
#annotationTable tr.playing { background: rgba(33, 150, 243, 0.15) !important; border-left: 3px solid #2196F3; }
[data-theme="dark"] #annotationTable tr.playing { background: rgba(33, 150, 243, 0.2) !important; }
/* å‹•ç”»ã‚¨ãƒªã‚¢å†ç”Ÿä¸­ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
.section.annotation-active { background: rgba(33, 150, 243, 0.18) !important; border: 2px solid #2196F3; }
[data-theme="dark"] .section.annotation-active { background: rgba(33, 150, 243, 0.25) !important; border-color: #42a5f5; }

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
#status { font-size: 14px; color: var(--text-secondary); margin: 8px 0; }
#status.error { color: #f44336; }
#status.success { color: #4CAF50; }

/* è‡ªå‹•ä¿å­˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
#autoSaveStatus {
  font-size: 13px;
  padding: 8px 12px;
  border-radius: 4px;
  margin: 8px 0;
  display: none;
}
#autoSaveStatus.active {
  display: block;
  background: #e8f5e9;
  color: #2e7d32;
  border: 1px solid #a5d6a7;
}
[data-theme="dark"] #autoSaveStatus.active {
  background: #1b3d1f;
  color: #81c784;
  border-color: #2e5a32;
}

/* è‡ªå‹•ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
#autoSaveIndicator {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #4CAF50;
  color: white;
  padding: 10px 16px;
  border-radius: 8px;
  font-size: 14px;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.3s, transform 0.3s;
  z-index: 1000;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
#autoSaveIndicator.show {
  opacity: 1;
  transform: translateY(0);
}

/* ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ« */
.backup-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: 3000;
  align-items: center;
  justify-content: center;
}

.backup-modal.show {
  display: flex;
}

.backup-modal-content {
  background: var(--bg-color);
  border-radius: 12px;
  padding: 24px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.backup-modal-content h4 {
  margin: 0 0 12px 0;
  font-size: 18px;
}

.backup-modal-content p {
  margin: 8px 0;
}

/* ã‚¿ã‚¤ãƒãƒ¼ãƒ‘ãƒãƒ«ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ */
.timer-panel-compact {
  background: var(--bg-secondary);
  border-radius: 8px;
  padding: 8px 12px;
  margin: 0;
  border: 1px solid var(--border-color);
}

.timer-panel-compact.running {
  border-color: #4CAF50;
  background: linear-gradient(135deg, var(--bg-secondary), rgba(76, 175, 80, 0.08));
}

.timer-compact-row {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.timer-compact-label {
  font-size: 14px;
}

.timer-compact-display {
  font-family: monospace;
  font-size: 18px;
  font-weight: bold;
  color: var(--text-color);
  min-width: 80px;
}

.timer-panel-compact.running .timer-compact-display {
  color: #4CAF50;
}

.timer-compact-stats {
  font-size: 13px;
  color: var(--text-secondary);
  margin-left: auto;
}

.timer-panel-compact .timer-avg {
  margin-top: 6px;
  padding: 4px 8px;
  background: #2196F3;
  color: white;
  border-radius: 4px;
  font-size: 12px;
  display: inline-flex;
  gap: 6px;
  align-items: center;
}

.timer-panel-compact .timer-avg-value {
  font-size: 14px;
  font-weight: bold;
}

.timer-panel-compact .timer-avg-label {
  font-size: 11px;
  opacity: 0.9;
}

/* CSVã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒãƒ¼ */
.csv-shortcuts-bar {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  background: var(--bg-secondary);
  border-radius: 8px;
  font-size: 13px;
  color: var(--text-secondary);
  flex-wrap: wrap;
  margin-top: 8px;
}

.csv-shortcuts-bar button {
  font-size: 12px;
  padding: 4px 8px;
  margin: 0;
}

.csv-shortcuts-bar #status {
  font-size: 12px;
  margin: 0;
}

.csv-shortcuts-bar #autoSaveStatus {
  font-size: 12px;
  margin: 0;
  padding: 2px 8px;
}

/* ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
.theme-toggle-container {
  position: fixed;
  top: 16px;
  right: 16px;
  z-index: 1000;
}

.theme-toggle {
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  padding: 8px 16px;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-color);
  transition: background 0.3s, border-color 0.3s;
}

.theme-toggle:hover {
  background: var(--table-hover);
}

.theme-toggle .icon {
  font-size: 16px;
}

/* PCç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
@media (min-width: 1024px) {
  #container {
    max-width: none;
  }

  .main-grid {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-height: 0;
    overflow: hidden;
    gap: 4px;
  }

  .top-row {
    display: flex;
    align-items: stretch;
    gap: 0;
    flex: 0 0 auto;
    max-height: 50%;
    min-height: 0;
    overflow: hidden;
  }

  .top-left, .top-right {
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 300px;
    overflow: hidden;
  }

  .top-left {
    flex: 1 1 50%;
  }

  .top-right {
    flex: 1 1 50%;
    overflow: hidden;
  }

  .top-right > .section {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
  }

  .top-right > .section #editForm {
    flex: 1;
    min-height: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .top-right > .section .query-input-container {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  .top-right > .section #editQuery {
    height: 2.8em;
    min-height: 2.4em;
    max-height: 4em;
    resize: vertical;
  }

  .bottom-row {
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .section {
    margin: 0;
  }

  .top-left > .section {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .top-left > .section video {
    flex: 1;
    min-height: 0;
    object-fit: contain;
  }

  video {
    max-height: none;
    width: 100%;
  }

  #tableContainer {
    max-height: none;
    flex: 1;
    min-height: 0;
    overflow-y: auto;
  }

  .bottom-row > .section {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
    margin: 0;
  }

  /* ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« */
  .resize-handle {
    width: 8px;
    background: var(--border-color);
    cursor: col-resize;
    flex-shrink: 0;
    position: relative;
    transition: background 0.2s;
    margin: 0 4px;
    border-radius: 4px;
  }

  .resize-handle:hover,
  .resize-handle.dragging {
    background: #2196F3;
  }

  .resize-handle::after {
    content: "â‹®";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--text-secondary);
    font-size: 14px;
  }

  .resize-handle:hover::after,
  .resize-handle.dragging::after {
    color: white;
  }
}

/* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«éè¡¨ç¤º */
@media (max-width: 1023px) {
  .resize-handle {
    display: none;
  }
}

/* ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒ˜ãƒ«ãƒ— */
.shortcut-help-btn {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  font-size: 18px;
  cursor: pointer;
  z-index: 1000;
  color: var(--text-color);
  display: flex;
  align-items: center;
  justify-content: center;
}

.shortcut-help-btn:hover {
  background: var(--table-hover);
}

.shortcut-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 2000;
  align-items: center;
  justify-content: center;
}

.shortcut-modal.show {
  display: flex;
}

.shortcut-content {
  background: var(--bg-color);
  border-radius: 12px;
  padding: 24px;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.shortcut-content h3 {
  margin-top: 0;
  margin-bottom: 16px;
}

.shortcut-section {
  margin-bottom: 16px;
}

.shortcut-section h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: var(--text-secondary);
}

.shortcut-item {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid var(--border-color);
}

.shortcut-item:last-child {
  border-bottom: none;
}

.shortcut-key {
  background: var(--bg-tertiary);
  padding: 2px 8px;
  border-radius: 4px;
  font-family: monospace;
  font-size: 13px;
}

.shortcut-close {
  position: absolute;
  top: 10px;
  right: 10px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--text-color);
}

/* ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰è¡¨ç¤ºï¼ˆãƒœã‚¿ãƒ³æ¨ªï¼‰ */
.key-hint {
  font-size: 13px;
  font-weight: bold;
  color: #000000;
  margin-left: 6px;
  background: #f0f0f0;
  padding: 2px 8px;
  border-radius: 4px;
  border: 1px solid #999;
}

[data-theme="dark"] .key-hint {
  color: #ffffff;
  background: #444;
  border-color: #666;
}

@media (max-width: 1023px) {
  .key-hint {
    display: none;
  }
  .shortcut-help-btn {
    display: none;
  }
  #volumeBar, #volumeDisplay, #boostIndicator {
    display: none;
  }
}

/* çµ±è¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« */
.stats-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: 3000;
  align-items: center;
  justify-content: center;
}
.stats-modal.show { display: flex; }
.stats-modal-content {
  background: var(--bg-color);
  border-radius: 12px;
  padding: 24px;
  max-width: 700px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
.stats-modal-content h3 { margin-top: 0; }
.stats-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}
.stats-summary-card {
  background: var(--bg-secondary);
  border-radius: 8px;
  padding: 12px;
  text-align: center;
}
.stats-summary-card .stat-value {
  font-size: 22px;
  font-weight: bold;
  color: #2196F3;
}
.stats-summary-card .stat-label {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 4px;
}
.stats-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  margin-top: 12px;
}
.stats-table th, .stats-table td {
  border: 1px solid var(--border-color);
  padding: 6px 8px;
  text-align: left;
  color: var(--text-color);
}
.stats-table th {
  background: var(--table-header);
  white-space: nowrap;
  font-size: 12px;
}
.stats-file-actions {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
  align-items: center;
}
.stats-file-status {
  font-size: 12px;
  color: var(--text-secondary);
}
.stats-btn {
  font-size: 13px;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  border: 1px solid var(--border-color);
  background: var(--bg-secondary);
  color: var(--text-color);
}
.stats-btn:hover { background: var(--table-hover); }
.stats-btn-primary { background: #2196F3; color: white; border: none; }
.stats-btn-primary:hover { background: #1976D2; }
</style>
</head>
<body>
<div id="container">

<div class="main-grid" id="mainGrid">
<div class="top-row">
<div class="top-left" id="leftColumn">

<!-- å‹•ç”»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="section">
  <div id="currentVideoName" class="current-video-name">å‹•ç”»æœªé¸æŠ</div>
  <video id="video" playsinline webkit-playsinline></video>
  <div id="seekContainer">
    <input type="range" id="seekBar" min="0" max="100" step="0.01" value="0">
    <div class="video-status-bar">
      <span id="timeDisplay">00:00.000 / 00:00.000</span>
      <span id="speedDisplay">1.0x</span>
      <span id="volumeDisplay">100%</span>
      <span id="boostIndicator" style="display: none; color: #ff9800; font-weight: bold; font-size: 12px;">BOOST</span>
    </div>
  </div>
  <!-- å‹•ç”»é¸æŠ -->
  <div id="videoSelectorContainer" class="video-selector" style="display:none;">
    <div class="video-selector-row">
      <input type="text" id="videoSearchInput" placeholder="å‹•ç”»åã‚’å…¥åŠ›..." autocomplete="off">
      <span id="videoNavInfo" class="video-nav-info"></span>
    </div>
    <div id="videoSuggestions" class="video-suggestions"></div>
  </div>
  <!-- ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”¨ã®éè¡¨ç¤ºãƒœã‚¿ãƒ³ -->
  <div style="display:none;">
    <button id="btnRewind"></button>
    <button id="btnPlayPause"></button>
    <button id="btnFastFwd"></button>
    <button id="seekBack10"></button>
    <button id="seekBack1"></button>
    <button id="seekBackFrame"></button>
    <button id="seekFwdFrame"></button>
    <button id="seekFwd1"></button>
    <button id="seekFwd10"></button>
    <button id="muteBtn"></button>
    <input type="range" id="volumeBar" min="0" max="300" value="100">
  </div>
</div>

</div><!-- /top-left -->

<div class="resize-handle" id="resizeHandle"></div>

<div class="top-right" id="rightColumn">

<!-- ã‚¿ã‚¤ãƒãƒ¼ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ -->
<div class="timer-panel-compact" id="timerPanel">
  <div class="timer-compact-row">
    <span class="timer-compact-label">â±ï¸</span>
    <span class="timer-compact-display" id="timerDisplay">00:00:00</span>
    <button id="timerStartBtn" class="btn-primary btn-small" title="T">â–¶<span class="key-hint">[T]</span></button>
    <button id="timerStopBtn" class="btn-secondary btn-small" disabled title="T">â¸<span class="key-hint">[T]</span></button>
    <button id="timerResetBtn" class="btn-secondary btn-small" title="Y">â†º<span class="key-hint">[Y]</span></button>
    <button id="statsBtn" class="btn-secondary btn-small" title="U">ğŸ“Š<span class="key-hint">[U]</span></button>
    <span class="timer-compact-stats">
      <span id="timerCount">0</span>ä»¶ | <span id="timerRate">-</span>ä»¶/æ™‚
    </span>
  </div>
  <div class="timer-avg" id="timerAvgPanel" style="display: none;">
    <span class="timer-avg-label">å¹³å‡</span>
    <span class="timer-avg-value" id="timerAvg">--:--</span>
  </div>
</div>

<!-- ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="section">
  <h4 id="formTitle">æ–°è¦ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</h4>
  <div id="editForm">
    <input type="hidden" id="editId" value="">
    <div>
      <label>video_id</label>
      <input type="text" id="editVideoId" readonly style="background: var(--bg-tertiary);">
    </div>
    <div>
      <label>start</label>
      <input type="number" id="editStart" step="0.1" placeholder="0.0">
      <button type="button" id="setStartBtn" class="btn-secondary btn-small" title="S" style="display:none;">ç¾åœ¨æ™‚åˆ»</button>
    </div>
    <div>
      <label>end</label>
      <input type="number" id="editEnd" step="0.1" placeholder="0.0">
      <button type="button" id="setEndBtn" class="btn-secondary btn-small" title="E" style="display:none;">ç¾åœ¨æ™‚åˆ»</button>
    </div>
    <div class="query-input-container">
      <label>query <span id="insertModeIndicator" class="insert-mode-indicator">[I] ã§å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</span></label>
      <textarea id="editQuery" placeholder="The nurse performs..."></textarea>
      <div id="suggestions"></div>
    </div>
    <div style="display:none;">
      <button type="button" id="pasteBtn" class="btn-secondary btn-small" title="V">ãƒšãƒ¼ã‚¹ãƒˆ</button>
      <button id="saveBtn" class="btn-primary" title="Enter">è¿½åŠ </button>
      <button id="clearFormBtn" class="btn-secondary" title="C">ã‚¯ãƒªã‚¢</button>
    </div>
  </div>
</div>

</div><!-- /top-right -->
</div><!-- /top-row -->

<!-- ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ï¼ˆæ¨ªå¹…ãƒ•ãƒ«ï¼‰ -->
<div class="bottom-row">
<div class="section">
  <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
    <h4>ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ (<span id="annotationCount">0</span>ä»¶)</h4>
    <button id="sortAnnotationsBtn" class="btn-secondary btn-small">æ•´åˆ—</button>
  </div>
  <div id="tableContainer">
    <table id="annotationTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>video_id</th>
          <th>start</th>
          <th>end</th>
          <th>query</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="annotationBody">
      </tbody>
    </table>
  </div>
</div>
</div><!-- /bottom-row -->

<!-- CSVã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ -->
<div class="csv-shortcuts-bar">
  <input type="file" id="file" accept="video/*" style="display:none;">
  <span>CSV:</span>
  <button id="loadCsvBtn" class="btn-secondary btn-small">èª­ã¿è¾¼ã¿</button>
  <button id="downloadCsvBtn" class="btn-secondary btn-small">ä¿å­˜</button>
  <button id="restoreFromBackupBtn" class="btn-secondary btn-small">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒ</button>
  <span id="autoSaveStatus"></span>
  <span id="status"></span>
  <div id="backupStatus" style="display: none; font-size: 12px; color: var(--text-secondary);"></div>
  <div id="autoSaveIndicator">âœ“ è‡ªå‹•ä¿å­˜å®Œäº†</div>
</div>

<!-- éè¡¨ç¤ºã®ã‚¿ã‚¤ãƒãƒ¼çµ±è¨ˆç”¨è¦ç´  -->
<span id="timerTotalTime" style="display:none;">00:00</span>

<!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="backup-modal" id="backupModal">
  <div class="backup-modal-content">
    <h4>ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</h4>
    <p id="backupInfo"></p>
    <p style="font-size: 13px; color: var(--text-secondary);">å‰å›ã®ä½œæ¥­ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ</p>
    <div style="display: flex; gap: 8px; margin-top: 16px;">
      <button id="restoreBackupBtn" class="btn-primary" style="flex: 1;">å¾©å…ƒã™ã‚‹ [Enter]</button>
      <button id="ignoreBackupBtn" class="btn-secondary" style="flex: 1;">ç„¡è¦–ã™ã‚‹ [Esc]</button>
    </div>
  </div>
</div>

</div><!-- /main-grid -->

<!-- çµ±è¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="stats-modal" id="statsModal">
  <div class="stats-modal-content">
    <h3>ğŸ“Š ä½œæ¥­ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆ</h3>
    <div class="stats-file-actions">
      <button class="stats-btn stats-btn-primary" id="statsOpenBtn">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</button>
      <button class="stats-btn" id="statsCreateBtn">æ–°è¦ä½œæˆ</button>
      <span class="stats-file-status" id="statsFileStatus">æœªæ¥ç¶š</span>
    </div>
    <div class="stats-summary" id="statsSummary"></div>
    <div id="statsTableContainer"></div>
    <button class="btn-secondary" style="width: 100%; margin-top: 12px;" onclick="document.getElementById('statsModal').classList.remove('show')">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ -->
<button class="shortcut-help-btn" id="shortcutHelpBtn" title="ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ">âŒ¨</button>

<!-- ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="shortcut-modal" id="shortcutModal">
  <div class="shortcut-content">
    <h3>âŒ¨ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h3>
    <div class="shortcut-section">
      <h4>å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h4>
      <div class="shortcut-item"><span>å†ç”Ÿ/ä¸€æ™‚åœæ­¢</span><span class="shortcut-key">Space</span></div>
      <div class="shortcut-item"><span>ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ</span><span class="shortcut-key">,</span></div>
      <div class="shortcut-item"><span>éŸ³é‡+10%</span><span class="shortcut-key">â†‘ / ]</span></div>
      <div class="shortcut-item"><span>éŸ³é‡-10%</span><span class="shortcut-key">â†“ / [</span></div>
    </div>
    <div class="shortcut-section">
      <h4>ã‚·ãƒ¼ã‚¯</h4>
      <div class="shortcut-item"><span>-10ç§’ / +10ç§’</span><span class="shortcut-key">N / M</span></div>
      <div class="shortcut-item"><span>-1ç§’ / +1ç§’</span><span class="shortcut-key">H / L</span></div>
      <div class="shortcut-item"><span>-0.1ç§’ / +0.1ç§’</span><span class="shortcut-key">J / K</span></div>
    </div>
    <div class="shortcut-section">
      <h4>ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</h4>
      <div class="shortcut-item"><span>Startæ™‚åˆ»ã‚’ã‚»ãƒƒãƒˆ</span><span class="shortcut-key">S</span></div>
      <div class="shortcut-item"><span>Endæ™‚åˆ»ã‚’ã‚»ãƒƒãƒˆ</span><span class="shortcut-key">E</span></div>
      <div class="shortcut-item"><span>è¿½åŠ /æ›´æ–°</span><span class="shortcut-key">Enter</span></div>
      <div class="shortcut-item"><span>ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢</span><span class="shortcut-key">C</span></div>
    </div>
    <div class="shortcut-section">
      <h4>ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§</h4>
      <div class="shortcut-item"><span>è¡Œé¸æŠ</span><span class="shortcut-key">â†‘ / â†“</span></div>
      <div class="shortcut-item"><span>å…ˆé ­/æœ«å°¾ã¸</span><span class="shortcut-key">Home / End</span></div>
      <div class="shortcut-item"><span>æ™‚é–“ã«ã‚¸ãƒ£ãƒ³ãƒ—</span><span class="shortcut-key">G</span></div>
      <div class="shortcut-item"><span>ç·¨é›†</span><span class="shortcut-key">F</span></div>
      <div class="shortcut-item"><span>å‰Šé™¤</span><span class="shortcut-key">Delete</span></div>
      <div class="shortcut-item"><span>ä¸€è¦§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</span><span class="shortcut-key">PageUp / PageDown</span></div>
    </div>
    <div class="shortcut-section">
      <h4>ã‚¯ã‚¨ãƒªå…¥åŠ›</h4>
      <div class="shortcut-item"><span>å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</span><span class="shortcut-key">I</span></div>
      <div class="shortcut-item"><span>å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰çµ‚äº†</span><span class="shortcut-key">Esc</span></div>
      <div class="shortcut-item"><span>ãƒšãƒ¼ã‚¹ãƒˆ</span><span class="shortcut-key">V</span></div>
    </div>
    <div class="shortcut-section">
      <h4>ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ã‚¿ã‚¤ãƒãƒ¼</h4>
      <div class="shortcut-item"><span>å‹•ç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã</span><span class="shortcut-key">O</span></div>
      <div class="shortcut-item"><span>å‰ã®å‹•ç”» / æ¬¡ã®å‹•ç”»</span><span class="shortcut-key">Q / W</span></div>
      <div class="shortcut-item"><span>å‹•ç”»ã‚’æ¤œç´¢</span><span class="shortcut-key">/</span></div>
      <div class="shortcut-item"><span>ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹/åœæ­¢</span><span class="shortcut-key">T</span></div>
      <div class="shortcut-item"><span>ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ</span><span class="shortcut-key">Y</span></div>
      <div class="shortcut-item"><span>çµ±è¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«</span><span class="shortcut-key">U</span></div>
      <div class="shortcut-item"><span>æ‰‹å‹•ä¿å­˜</span><span class="shortcut-key">Ctrl+S</span></div>
      <div class="shortcut-item"><span>ãƒ†ãƒ¼ãƒåˆ‡æ›¿</span><span class="shortcut-key">D</span></div>
    </div>
    <p style="text-align: center; margin-top: 16px; color: var(--text-secondary); font-size: 12px;">
      â€» å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã¯ç„¡åŠ¹
    </p>
    <button class="btn-secondary" style="width: 100%; margin-top: 8px;" onclick="document.getElementById('shortcutModal').classList.remove('show')">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
// ===== ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ =====
(function() {
  var savedTheme = localStorage.getItem("theme");
  var prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  var theme = savedTheme || (prefersDark ? "dark" : "light");
  document.documentElement.setAttribute("data-theme", theme);
})();

function toggleTheme() {
  var html = document.documentElement;
  var currentTheme = html.getAttribute("data-theme");
  var newTheme = currentTheme === "dark" ? "light" : "dark";
  html.setAttribute("data-theme", newTheme);
  localStorage.setItem("theme", newTheme);
  updateThemeButton(newTheme);
}

function updateThemeButton(theme) {
  var icon = document.getElementById("themeIcon");
  var text = document.getElementById("themeText");
  if (theme === "dark") {
    icon.textContent = "â˜€ï¸";
    text.textContent = "ãƒ©ã‚¤ãƒˆ";
  } else {
    icon.textContent = "ğŸŒ™";
    text.textContent = "ãƒ€ãƒ¼ã‚¯";
  }
}

document.addEventListener("DOMContentLoaded", function() {
  var currentTheme = document.documentElement.getAttribute("data-theme");
  updateThemeButton(currentTheme);
});

// ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
var annotations = [];
var editingId = null;
var selectedRowIndex = -1;
var selectedAnnotationId = null;
var currentVideoId = "";
var directoryHandle = null; // å‹•ç”»ãƒ•ã‚©ãƒ«ãƒ€ç”¨
var videoFiles = {}; // videoId â†’ FileSystemFileHandle

// ===== ä½œæ¥­ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆ =====
var statsFileHandle = null;
var sessionLog = [];
var currentSessionStartIso = null;

// ===== DOMè¦ç´  =====
var v = document.getElementById("video");
var fileInput = document.getElementById("file");
var seekBar = document.getElementById("seekBar");
var timeDisplay = document.getElementById("timeDisplay");

// ===== ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ é˜²æ­¢ =====
document.addEventListener("touchstart", function(e) {
  // videoè¦ç´ å†…ã®ãƒãƒ«ãƒã‚¿ãƒƒãƒã¯è¨±å¯ï¼ˆãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ãªã©ï¼‰
  if (e.target.tagName === "VIDEO" || e.target.closest("video")) {
    return;
  }
  if (e.touches.length > 1) e.preventDefault();
}, { passive: false });

document.addEventListener("gesturestart", function(e) {
  // videoè¦ç´ å†…ã®ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã¯è¨±å¯
  if (e.target.tagName === "VIDEO" || e.target.closest("video")) {
    return;
  }
  e.preventDefault();
}, { passive: false });

// ===== ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é˜²æ­¢ =====
var container = document.getElementById("container");
var lastY = 0;

container.addEventListener("touchstart", function(e) {
  lastY = e.touches[0].clientY;
}, { passive: true });

container.addEventListener("touchmove", function(e) {
  // videoè¦ç´ ã‚„ãã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å†…ã®ã‚¿ãƒƒãƒã¯ç„¡è¦–
  var target = e.target;
  if (target.tagName === "VIDEO" || target.closest("video")) {
    return;
  }

  var y = e.touches[0].clientY;
  var scrollTop = container.scrollTop;
  if (scrollTop <= 0 && y > lastY) {
    e.preventDefault();
  }
  lastY = y;
}, { passive: false });

// ===== å‹•ç”»ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ =====
var VIDEO_EXTENSIONS = [".mp4", ".webm", ".mov", ".avi", ".mkv", ".m4v"];

async function openVideoFolder() {
  try {
    var resp = await fetch("/video-list");
    if (!resp.ok) throw new Error("HTTP " + resp.status);
    var files = await resp.json();
    if (files.error) throw new Error(files.error);
    videoFiles = {};
    for (var i = 0; i < files.length; i++) {
      var name = files[i];
      var videoId = name.replace(/\.[^.]+$/, "");
      videoFiles[videoId] = name; // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¿æŒ
    }
    renderVideoList();
    var keys = Object.keys(videoFiles).sort();
    if (keys.length > 0 && !currentVideoId) {
      var lastVid = localStorage.getItem("lastAnnotatedVideoId");
      if (lastVid && videoFiles[lastVid]) {
        await switchVideo(lastVid);
      } else {
        await switchVideo(keys[0]);
      }
    }
    document.activeElement && document.activeElement.blur();
  } catch (err) {
    showStatus("å‹•ç”»ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message, "error");
  }
}

async function switchVideo(videoId) {
  var fileName = videoFiles[videoId];
  if (!fileName) {
    showStatus("å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + videoId, "error");
    return;
  }
  v.src = "/videos/" + encodeURIComponent(fileName);
  currentVideoId = videoId;
  document.getElementById("editVideoId").value = currentVideoId;
  document.getElementById("currentVideoName").textContent = currentVideoId;
  renderVideoList();
}

// ===== å‹•ç”»æ¤œç´¢ãƒ»é¸æŠUI =====
var sortedVideoKeys = [];
var videoSearchSelectedIndex = -1;

function renderVideoList() {
  var container = document.getElementById("videoSelectorContainer");
  sortedVideoKeys = Object.keys(videoFiles).sort();
  if (sortedVideoKeys.length === 0) {
    container.style.display = "none";
    return;
  }
  container.style.display = "";
  updateVideoNavInfo();
  document.getElementById("videoSearchInput").value = "";
  hideVideoSuggestions();
}

function updateVideoNavInfo() {
  var info = document.getElementById("videoNavInfo");
  if (sortedVideoKeys.length === 0) { info.textContent = ""; return; }
  var idx = sortedVideoKeys.indexOf(currentVideoId);
  info.textContent = (idx + 1) + "/" + sortedVideoKeys.length + " [W]å‰ [Q]æ¬¡";
}

function showVideoSuggestions(filter) {
  var box = document.getElementById("videoSuggestions");
  box.innerHTML = "";
  var matches = [];
  var lower = filter.toLowerCase();
  for (var i = 0; i < sortedVideoKeys.length; i++) {
    if (sortedVideoKeys[i].toLowerCase().indexOf(lower) !== -1) {
      matches.push(sortedVideoKeys[i]);
    }
  }
  if (matches.length === 0 || (matches.length === 1 && matches[0] === currentVideoId && !filter)) {
    box.classList.remove("show");
    return;
  }
  videoSearchSelectedIndex = -1;
  for (var j = 0; j < matches.length; j++) {
    var div = document.createElement("div");
    div.className = "video-suggestion-item" + (matches[j] === currentVideoId ? " active-video" : "");
    div.textContent = matches[j];
    div.dataset.videoId = matches[j];
    div.onclick = function() {
      switchVideo(this.dataset.videoId);
      document.getElementById("videoSearchInput").value = "";
      hideVideoSuggestions();
      document.getElementById("videoSearchInput").blur();
    };
    box.appendChild(div);
  }
  box.classList.add("show");
}

function hideVideoSuggestions() {
  document.getElementById("videoSuggestions").classList.remove("show");
  videoSearchSelectedIndex = -1;
}

function navigateVideo(delta) {
  if (sortedVideoKeys.length === 0) return;
  var idx = sortedVideoKeys.indexOf(currentVideoId);
  var next = idx + delta;
  if (next < 0) next = sortedVideoKeys.length - 1;
  if (next >= sortedVideoKeys.length) next = 0;
  switchVideo(sortedVideoKeys[next]);
}

// æ¤œç´¢å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
(function() {
  var input = document.getElementById("videoSearchInput");
  var box = document.getElementById("videoSuggestions");

  input.addEventListener("input", function() {
    showVideoSuggestions(this.value);
  });

  input.addEventListener("focus", function() {
    if (sortedVideoKeys.length > 0) {
      showVideoSuggestions(this.value);
    }
  });

  input.addEventListener("blur", function() {
    // å°‘ã—é…å»¶ã—ã¦ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‹¾ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
    setTimeout(function() { hideVideoSuggestions(); }, 150);
  });

  input.addEventListener("keydown", function(e) {
    e.stopPropagation(); // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¸ã®ä¼æ¬ã‚’é˜²æ­¢
    var items = box.querySelectorAll(".video-suggestion-item");
    if (!box.classList.contains("show") || items.length === 0) {
      if (e.key === "Escape") {
        e.preventDefault();
        this.value = "";
        hideVideoSuggestions();
        this.blur();
      } else if (e.key === "Enter") {
        e.preventDefault();
      }
      return;
    }

    if (e.key === "ArrowDown") {
      e.preventDefault();
      videoSearchSelectedIndex = Math.min(videoSearchSelectedIndex + 1, items.length - 1);
      updateVideoSuggestionSelection(items);
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      videoSearchSelectedIndex = Math.max(videoSearchSelectedIndex - 1, 0);
      updateVideoSuggestionSelection(items);
    } else if (e.key === "Enter") {
      e.preventDefault();
      if (videoSearchSelectedIndex >= 0 && videoSearchSelectedIndex < items.length) {
        switchVideo(items[videoSearchSelectedIndex].dataset.videoId);
      } else if (items.length > 0) {
        switchVideo(items[0].dataset.videoId);
      }
      this.value = "";
      hideVideoSuggestions();
      this.blur();
    } else if (e.key === "Escape") {
      e.preventDefault();
      this.value = "";
      hideVideoSuggestions();
      this.blur();
    }
  });

  function updateVideoSuggestionSelection(items) {
    for (var i = 0; i < items.length; i++) {
      items[i].classList.toggle("selected", i === videoSearchSelectedIndex);
    }
    if (videoSearchSelectedIndex >= 0) {
      items[videoSearchSelectedIndex].scrollIntoView({ block: "nearest" });
    }
  }
})();

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
fileInput.onchange = function(e) {
  var files = e.target.files;
  if (!files || files.length === 0) return;
  var url = URL.createObjectURL(files[0]);
  v.src = url;
  var filename = files[0].name;
  currentVideoId = filename.replace(/\.[^.]+$/, "");
  document.getElementById("editVideoId").value = currentVideoId;
  document.getElementById("currentVideoName").textContent = currentVideoId;
  fileInput.blur();
};

// ===== æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ =====
function formatTime(sec) {
  if (isNaN(sec) || !isFinite(sec)) return "0.000";
  return sec.toFixed(3);
}

function formatTimeForCopy(sec) {
  if (isNaN(sec) || !isFinite(sec)) return "0.0";
  return sec.toFixed(1);
}

function updateTimeDisplay() {
  var current = formatTime(v.currentTime);
  var total = formatTime(v.duration);
  timeDisplay.textContent = current + " / " + total;
  if (v.duration > 0) {
    seekBar.value = (v.currentTime / v.duration) * 100;
  }
  updatePlayingHighlight();
}

function updatePlayingHighlight() {
  var rows = document.querySelectorAll("#annotationBody tr");
  var t = v.currentTime;
  var anyPlaying = false;
  for (var i = 0; i < rows.length; i++) {
    var id = parseInt(rows[i].dataset.id);
    var a = annotations.find(function(x) { return x.id === id; });
    if (a && a.video_id === currentVideoId && t >= a.start && t <= a.end) {
      rows[i].classList.add("playing");
      anyPlaying = true;
    } else {
      rows[i].classList.remove("playing");
    }
  }
  var videoSection = v.closest(".section");
  if (anyPlaying) {
    videoSection.classList.add("annotation-active");
  } else {
    videoSection.classList.remove("annotation-active");
  }
}

v.ontimeupdate = updateTimeDisplay;
v.ondurationchange = updateTimeDisplay;

seekBar.oninput = function() {
  if (v.duration > 0) {
    v.currentTime = (seekBar.value / 100) * v.duration;
    updateTimeDisplay();
  }
};

// ===== æ™‚é–“ã‚¸ãƒ£ãƒ³ãƒ— =====
function seekToTime(time) {
  v.currentTime = Math.max(0, Math.min(v.duration || 0, time));
  updateTimeDisplay();
}

async function jumpToAnnotationTime(annotationId, useEnd) {
  var a = annotations.find(function(x) { return x.id === annotationId; });
  if (!a) return;
  var time = useEnd ? a.end : a.start;
  if (a.video_id !== currentVideoId) {
    if (videoFiles[a.video_id]) {
      await switchVideo(a.video_id);
      // å‹•ç”»èª­ã¿è¾¼ã¿å¾Œã«ã‚·ãƒ¼ã‚¯
      v.addEventListener("loadedmetadata", function onLoaded() {
        v.removeEventListener("loadedmetadata", onLoaded);
        seekToTime(time);
      });
      return;
    }
    showStatus("å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + a.video_id + "ï¼ˆOã‚­ãƒ¼ã§ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼‰", "error");
    return;
  }
  seekToTime(time);
}

// ===== ç´°ã‹ã„ã‚·ãƒ¼ã‚¯ãƒœã‚¿ãƒ³ =====
function seekBy(sec, pauseVideo) {
  if (pauseVideo !== false && !v.paused) v.pause();
  v.currentTime = Math.max(0, Math.min(v.duration || 0, v.currentTime + sec));
  updateTimeDisplay();
}

document.getElementById("seekBack10").onclick = function() { seekBy(-10, false); };
document.getElementById("seekBack1").onclick = function() { seekBy(-1); };
document.getElementById("seekBackFrame").onclick = function() { seekBy(-0.1); };
document.getElementById("seekFwdFrame").onclick = function() { seekBy(0.1); };
document.getElementById("seekFwd1").onclick = function() { seekBy(1); };
document.getElementById("seekFwd10").onclick = function() { seekBy(10, false); };

// ===== éŸ³é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆãƒ–ãƒ¼ã‚¹ãƒˆå¯¾å¿œï¼‰ =====
var volumeBar = document.getElementById("volumeBar");
var volumeDisplay = document.getElementById("volumeDisplay");
var muteBtn = document.getElementById("muteBtn");
var boostIndicator = document.getElementById("boostIndicator");

// Web Audio API for volume boost
var audioContext = null;
var gainNode = null;
var audioSource = null;
var currentVolume = 100; // 0-300%

function initAudioBoost() {
  if (audioContext) return; // Already initialized

  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    gainNode = audioContext.createGain();
    audioSource = audioContext.createMediaElementSource(v);
    audioSource.connect(gainNode);
    gainNode.connect(audioContext.destination);
    applyVolume(currentVolume);
  } catch (err) {
    console.error("Web Audio APIåˆæœŸåŒ–å¤±æ•—:", err);
  }
}

function applyVolume(percent) {
  currentVolume = percent;

  if (percent <= 100) {
    // é€šå¸¸ç¯„å›²: videoã®volumeã§åˆ¶å¾¡
    v.volume = percent / 100;
    if (gainNode) gainNode.gain.value = 1;
    boostIndicator.style.display = "none";
  } else {
    // ãƒ–ãƒ¼ã‚¹ãƒˆç¯„å›²: videoã¯100%ã€gainNodeã§å¢—å¹…
    v.volume = 1;
    if (gainNode) {
      gainNode.gain.value = percent / 100;
    }
    boostIndicator.style.display = "inline";
  }
}

function updateVolumeDisplay() {
  volumeBar.value = currentVolume;
  volumeDisplay.textContent = currentVolume + "%";

  if (v.muted || currentVolume === 0) {
    muteBtn.textContent = "ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ";
    boostIndicator.style.display = "none";
  } else if (currentVolume > 100) {
    muteBtn.textContent = "ğŸ”Š éŸ³ã‚ã‚Š";
    boostIndicator.style.display = "inline";
  } else {
    muteBtn.textContent = "ğŸ”Š éŸ³ã‚ã‚Š";
    boostIndicator.style.display = "none";
  }
}

volumeBar.oninput = function() {
  var vol = parseInt(volumeBar.value);
  v.muted = false;

  // åˆå›æ“ä½œæ™‚ã«AudioContextã‚’åˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ãªãŸã‚ï¼‰
  if (!audioContext && vol > 100) {
    initAudioBoost();
  }

  applyVolume(vol);
  updateVolumeDisplay();
};

muteBtn.onclick = function() {
  if (v.muted) {
    v.muted = false;
    if (currentVolume === 0) {
      currentVolume = 100;
      applyVolume(100);
    }
  } else {
    v.muted = true;
  }
  updateVolumeDisplay();
};

// éŸ³é‡èª¿æ•´é–¢æ•°ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”¨ï¼‰
function adjustVolume(delta) {
  var newVolume = currentVolume + delta;
  // 0ã€œ300%ã®ç¯„å›²ã«åˆ¶é™
  newVolume = Math.max(0, Math.min(300, newVolume));

  v.muted = false;

  // 100%è¶…ãˆã®å ´åˆã¯AudioContextã‚’åˆæœŸåŒ–
  if (!audioContext && newVolume > 100) {
    initAudioBoost();
  }

  applyVolume(newVolume);
  updateVolumeDisplay();
}

// å‹•ç”»èª­ã¿è¾¼ã¿æ™‚ã«AudioContextã‚’æº–å‚™
v.addEventListener("loadeddata", function() {
  if (currentVolume > 100 && !audioContext) {
    // ãƒ–ãƒ¼ã‚¹ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ãŸã‚‰åˆæœŸåŒ–
    initAudioBoost();
  }
  applyVolume(currentVolume);
  updateVolumeDisplay();
});

// åˆæœŸçŠ¶æ…‹ã§100%éŸ³é‡
currentVolume = 100;
updateVolumeDisplay();

// ===== å†ç”Ÿãƒ»åœæ­¢ãƒ»æ—©é€ã‚Šãƒ»å·»ãæˆ»ã— =====
var speedSteps = [1, 2, 4, 8];
var currentSpeedIndex = 0;
var playbackMode = "normal"; // "normal", "fastfwd", "rewind"
var rewindInterval = null;

function updateSpeedDisplay() {
  var speed = speedSteps[currentSpeedIndex];
  if (playbackMode === "rewind") {
    document.getElementById("speedDisplay").textContent = "â—€â—€ " + speed + "x";
  } else if (playbackMode === "fastfwd") {
    document.getElementById("speedDisplay").textContent = speed + "x â–¶â–¶";
  } else {
    document.getElementById("speedDisplay").textContent = speed + "x";
  }
}

function stopRewind() {
  if (rewindInterval) {
    clearInterval(rewindInterval);
    rewindInterval = null;
  }
}

function resetPlayback() {
  stopRewind();
  playbackMode = "normal";
  currentSpeedIndex = 0;
  v.playbackRate = 1;
  updateSpeedDisplay();
}

document.getElementById("btnPlayPause").onclick = function() {
  resetPlayback();
  if (v.paused) {
    v.play();
  } else {
    v.pause();
  }
};

// å†ç”ŸçŠ¶æ…‹ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
function updatePlayPauseButton() {
  var btn = document.getElementById("btnPlayPause");
  if (v.paused) {
    btn.textContent = "â–¶";
  } else {
    btn.textContent = "â¸";
  }
}

v.onplay = updatePlayPauseButton;
v.onpause = updatePlayPauseButton;
v.onended = updatePlayPauseButton;

document.getElementById("btnFastFwd").onclick = function() {
  stopRewind();

  if (playbackMode === "fastfwd") {
    // æ¬¡ã®é€Ÿåº¦ã¸
    currentSpeedIndex++;
    if (currentSpeedIndex >= speedSteps.length) {
      // æœ€å¾Œã¾ã§è¡Œã£ãŸã‚‰é€šå¸¸ã«æˆ»ã‚‹
      resetPlayback();
      v.play();
      return;
    }
  } else {
    // æ—©é€ã‚Šãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
    playbackMode = "fastfwd";
    currentSpeedIndex = 1; // 2xã‹ã‚‰é–‹å§‹
  }

  v.playbackRate = speedSteps[currentSpeedIndex];
  v.play();
  updateSpeedDisplay();
};

document.getElementById("btnRewind").onclick = function() {
  if (playbackMode === "rewind") {
    // æ¬¡ã®é€Ÿåº¦ã¸
    currentSpeedIndex++;
    if (currentSpeedIndex >= speedSteps.length) {
      // æœ€å¾Œã¾ã§è¡Œã£ãŸã‚‰é€šå¸¸ã«æˆ»ã‚‹
      resetPlayback();
      v.play();
      return;
    }
  } else {
    // å·»ãæˆ»ã—ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
    stopRewind();
    playbackMode = "rewind";
    currentSpeedIndex = 1; // 2xã‹ã‚‰é–‹å§‹
    v.pause();
  }

  // å·»ãæˆ»ã—ã¯intervalã§å®Ÿè£…ï¼ˆè² ã®å†ç”Ÿé€Ÿåº¦ã¯éå¯¾å¿œã®ãŸã‚ï¼‰
  stopRewind();
  var speed = speedSteps[currentSpeedIndex];
  rewindInterval = setInterval(function() {
    v.currentTime = Math.max(0, v.currentTime - (speed * 0.1));
    updateTimeDisplay();
    if (v.currentTime <= 0) {
      resetPlayback();
    }
  }, 100);

  updateSpeedDisplay();
};

// ===== CSVèª­ã¿è¾¼ã¿ =====
document.getElementById("loadCsvBtn").onclick = function() {
  fetch("jichi2507_rule.csv?t=" + Date.now())
    .then(function(res) {
      if (!res.ok) throw new Error("CSV not found");
      return res.text();
    })
    .then(function(csv) {
      parseCsv(csv);
      showStatus("CSVèª­ã¿è¾¼ã¿å®Œäº† (" + annotations.length + "ä»¶)", "success");
    })
    .catch(function(err) {
      showStatus("CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message, "error");
    });
};

function parseCsv(csv) {
  var lines = csv.trim().split("\n");
  annotations = [];

  for (var i = 1; i < lines.length; i++) {
    var line = lines[i];
    if (!line.trim()) continue;

    // CSVãƒ‘ãƒ¼ã‚¹ï¼ˆã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
    var cols = parseCsvLine(line);
    if (cols.length >= 5) {
      annotations.push({
        id: parseInt(cols[0]) || i,
        video_id: cols[1],
        start: parseFloat(cols[2]) || 0,
        end: parseFloat(cols[3]) || 0,
        query: normalizeQuotes((cols[4] || "").trim())
      });
    }
  }

  renderTable();
  selectLastAnnotation();
}

function selectLastAnnotation() {
  if (annotations.length === 0) return;
  var lastId = annotations[annotations.length - 1].id;
  setTableSelectionById(lastId);
  var tc = document.getElementById("tableContainer");
  if (tc) tc.scrollTop = tc.scrollHeight;
}

function parseCsvLine(line) {
  var result = [];
  var current = "";
  var inQuotes = false;

  for (var i = 0; i < line.length; i++) {
    var c = line[i];
    if (c === '"') {
      inQuotes = !inQuotes;
    } else if (c === ',' && !inQuotes) {
      result.push(current);
      current = "";
    } else {
      current += c;
    }
  }
  result.push(current);
  return result;
}

// ===== CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ =====
document.getElementById("downloadCsvBtn").onclick = async function() {
  var csv = "id,video_id,start,end,query\n";

  for (var i = 0; i < annotations.length; i++) {
    var a = annotations[i];
    var query = a.query.replace(/"/g, '""');
    csv += a.id + "," + a.video_id + "," + a.start.toFixed(1) + "," + a.end.toFixed(1) + ',"' + query + '"\n';
  }

  // ã‚µãƒ¼ãƒãƒ¼ã«ç›´æ¥ä¿å­˜ï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãªã—ï¼‰
  try {
    var resp = await fetch("/save-csv", { method: "POST", body: csv });
    if (!resp.ok) throw new Error("HTTP " + resp.status);
    showStatus("CSVã‚’ä¸Šæ›¸ãä¿å­˜ã—ã¾ã—ãŸ (jichi2507_rule.csv)", "success");
  } catch (err) {
    showStatus("CSVä¿å­˜ã‚¨ãƒ©ãƒ¼: " + err.message, "error");
  }
};

// ===== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ =====
document.getElementById("restoreFromBackupBtn").onclick = function() {
  var backup = getBackupFromLocalStorage();
  if (!backup || !backup.annotations || backup.annotations.length === 0) {
    showStatus("å¾©å…ƒã§ãã‚‹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“", "error");
    return;
  }

  var timestamp = localStorage.getItem(BACKUP_TIMESTAMP_KEY) || "ä¸æ˜";
  if (confirm("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n\nä¿å­˜æ—¥æ™‚: " + timestamp + "\nãƒ‡ãƒ¼ã‚¿æ•°: " + backup.annotations.length + "ä»¶\n\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚")) {
    restoreFromBackup();
  }
};

// ===== CSVä¿å­˜é–¢æ•°ï¼ˆã‚µãƒ¼ãƒãƒ¼çµŒç”±ï¼‰ =====
async function saveToCsv(showMessage) {
  try {
    var csv = "id,video_id,start,end,query\n";
    for (var i = 0; i < annotations.length; i++) {
      var a = annotations[i];
      var query = a.query.replace(/"/g, '""');
      csv += a.id + "," + a.video_id + "," + a.start.toFixed(1) + "," + a.end.toFixed(1) + ',"' + query + '"\n';
    }

    var resp = await fetch("/save-csv", { method: "POST", body: csv });
    if (!resp.ok) throw new Error("HTTP " + resp.status);

    if (showMessage) {
      showStatus("ä¸Šæ›¸ãä¿å­˜ã—ã¾ã—ãŸ", "success");
    } else {
      showAutoSaveIndicator();
    }
    return true;
  } catch (err) {
    showStatus("è‡ªå‹•ä¿å­˜ã«å¤±æ•—: " + err.message, "error");
    return false;
  }
}

// ===== è‡ªå‹•ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ =====
function showAutoSaveIndicator() {
  var indicator = document.getElementById("autoSaveIndicator");
  if (indicator) {
    indicator.textContent = "âœ“ è‡ªå‹•ä¿å­˜å®Œäº†";
    indicator.classList.add("show");
    setTimeout(function() {
      indicator.classList.remove("show");
    }, 2000);
  }
}

// ===== localStorageãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— =====
var BACKUP_KEY = "annotationBackup";
var BACKUP_TIMESTAMP_KEY = "annotationBackupTime";
var hasUnsavedChanges = false;

function saveToLocalStorage() {
  try {
    var backupData = {
      annotations: annotations,
      videoId: currentVideoId,
      timestamp: Date.now()
    };
    localStorage.setItem(BACKUP_KEY, JSON.stringify(backupData));
    localStorage.setItem(BACKUP_TIMESTAMP_KEY, new Date().toLocaleString("ja-JP"));
    return true;
  } catch (err) {
    console.error("localStorageãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¤±æ•—:", err);
    return false;
  }
}

function getBackupFromLocalStorage() {
  try {
    var data = localStorage.getItem(BACKUP_KEY);
    if (data) {
      return JSON.parse(data);
    }
  } catch (err) {
    console.error("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­ã¿è¾¼ã¿å¤±æ•—:", err);
  }
  return null;
}

function clearBackup() {
  localStorage.removeItem(BACKUP_KEY);
  localStorage.removeItem(BACKUP_TIMESTAMP_KEY);
}

function restoreFromBackup() {
  var backup = getBackupFromLocalStorage();
  if (backup && backup.annotations) {
    annotations = backup.annotations.map(function(a) {
      a.query = normalizeQuotes((a.query || "").trim());
      return a;
    });
    if (backup.videoId) {
      currentVideoId = backup.videoId;
      document.getElementById("editVideoId").value = currentVideoId;
    }
    renderTable();
    selectLastAnnotation();
    showStatus("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ (" + annotations.length + "ä»¶)", "success");
    hasUnsavedChanges = true;
    updateBackupStatus();
    return true;
  }
  return false;
}

function updateBackupStatus() {
  var backupStatus = document.getElementById("backupStatus");
  var timestamp = localStorage.getItem(BACKUP_TIMESTAMP_KEY);
  if (backupStatus && timestamp) {
    backupStatus.textContent = "æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: " + timestamp;
    backupStatus.style.display = "block";
  }
}

// ===== è‡ªå‹•ä¿å­˜ã‚’å®Ÿè¡Œ =====
function autoSave() {
  // localStorageã«å¸¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  saveToLocalStorage();
  updateBackupStatus();

  // ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§CSVã«è‡ªå‹•ä¿å­˜
  saveToCsv(false);
  hasUnsavedChanges = false;
}

// ===== ãƒšãƒ¼ã‚¸é›¢è„±è­¦å‘Š =====
window.addEventListener("beforeunload", function(e) {
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²ã‚’è©¦ã¿ã‚‹ï¼ˆéåŒæœŸã ãŒæœ€å–„åŠªåŠ›ï¼‰
  finalizeSession();

  // CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒé–‹ã‹ã‚Œã¦ã„ãªã„å ´åˆã®ã¿è­¦å‘Š
  if (hasUnsavedChanges && annotations.length > 0) {
    e.preventDefault();
    e.returnValue = "æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã¾ã™ã‹ï¼Ÿ";
    return e.returnValue;
  }
});

// visibilitychangeã§ã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ã‚’è©¦ã¿ã‚‹ï¼ˆã‚ˆã‚Šä¿¡é ¼æ€§ãŒé«˜ã„ï¼‰
document.addEventListener("visibilitychange", function() {
  if (document.visibilityState === "hidden") {
    finalizeSession();
  }
});

// ===== ä½œæ¥­ã‚¿ã‚¤ãƒãƒ¼ =====
var timerState = {
  running: false,
  startTime: 0,
  elapsedTime: 0,
  annotationCount: 0,
  intervalId: null
};

var timerStorageKey = "vat_timer_state";

function saveTimerState() {
  try {
    var payload = {
      running: timerState.running,
      startTime: timerState.startTime,
      elapsedTime: timerState.elapsedTime,
      annotationCount: timerState.annotationCount,
      sessionStartIso: currentSessionStartIso || null
    };
    localStorage.setItem(timerStorageKey, JSON.stringify(payload));
  } catch (e) {
    // ignore storage errors
  }
}

function loadTimerState() {
  try {
    var raw = localStorage.getItem(timerStorageKey);
    if (!raw) return;
    var data = JSON.parse(raw);
    if (typeof data !== "object" || data === null) return;

    timerState.running = !!data.running;
    timerState.startTime = Number(data.startTime) || 0;
    timerState.elapsedTime = Number(data.elapsedTime) || 0;
    timerState.annotationCount = Number(data.annotationCount) || 0;

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚åˆ»ã®å¾©å…ƒ
    if (data.sessionStartIso) {
      currentSessionStartIso = data.sessionStartIso;
    }

    if (timerState.running && timerState.startTime > 0) {
      document.getElementById('timerPanel').classList.add('running');
      document.getElementById('timerDisplay').classList.add('running');
      document.getElementById('timerStartBtn').disabled = true;
      document.getElementById('timerStartBtn').textContent = 'â–¶ è¨ˆæ¸¬ä¸­...';
      document.getElementById('timerStopBtn').disabled = false;
      timerState.intervalId = setInterval(updateTimerDisplay, 1000);
    } else {
      // ã‚¿ã‚¤ãƒãƒ¼ãŒåœæ­¢ä¸­ãªã‚‰è‡ªå‹•èµ·å‹•
      timerState.running = true;
      timerState.startTime = Date.now();
      if (!currentSessionStartIso) {
        currentSessionStartIso = new Date().toISOString();
      }
      document.getElementById('timerPanel').classList.add('running');
      document.getElementById('timerDisplay').classList.add('running');
      document.getElementById('timerStartBtn').disabled = true;
      document.getElementById('timerStartBtn').textContent = 'â–¶ è¨ˆæ¸¬ä¸­...';
      document.getElementById('timerStopBtn').disabled = false;
      timerState.intervalId = setInterval(updateTimerDisplay, 1000);
      updateTimerDisplay();
      saveTimerState();
    }
  } catch (e) {
    // ignore parse errors
  }
}

function formatTimerTime(ms) {
  var totalSeconds = Math.floor(ms / 1000);
  var hours = Math.floor(totalSeconds / 3600);
  var minutes = Math.floor((totalSeconds % 3600) / 60);
  var seconds = totalSeconds % 60;
  return String(hours).padStart(2, '0') + ':' +
         String(minutes).padStart(2, '0') + ':' +
         String(seconds).padStart(2, '0');
}

function formatTimerShort(ms) {
  var totalSeconds = Math.floor(ms / 1000);
  var minutes = Math.floor(totalSeconds / 60);
  var seconds = totalSeconds % 60;
  if (minutes >= 60) {
    var hours = Math.floor(minutes / 60);
    minutes = minutes % 60;
    return hours + ':' + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
  }
  return String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
}

function updateTimerDisplay() {
  var currentElapsed = timerState.elapsedTime;
  if (timerState.running) {
    currentElapsed += Date.now() - timerState.startTime;
  }

  // ãƒ¡ã‚¤ãƒ³è¡¨ç¤º
  document.getElementById('timerDisplay').textContent = formatTimerTime(currentElapsed);

  // çµŒéæ™‚é–“ï¼ˆçŸ­ç¸®å½¢ï¼‰
  document.getElementById('timerTotalTime').textContent = formatTimerShort(currentElapsed);

  // è¿½åŠ æ•°
  document.getElementById('timerCount').textContent = timerState.annotationCount;

  // ä»¶/æ™‚ï¼ˆ1æ™‚é–“ã‚ãŸã‚Šã®ä»¶æ•°ï¼‰
  if (currentElapsed > 0 && timerState.annotationCount > 0) {
    var hoursElapsed = currentElapsed / (1000 * 60 * 60);
    var rate = timerState.annotationCount / hoursElapsed;
    document.getElementById('timerRate').textContent = rate.toFixed(1);
  } else {
    document.getElementById('timerRate').textContent = '-';
  }

  // å¹³å‡æ™‚é–“
  if (timerState.annotationCount > 0) {
    var avgMs = currentElapsed / timerState.annotationCount;
    document.getElementById('timerAvg').textContent = formatTimerShort(avgMs);
    document.getElementById('timerAvgPanel').style.display = 'block';
  } else {
    document.getElementById('timerAvgPanel').style.display = 'none';
  }

  saveTimerState();
}

function startTimer() {
  if (timerState.running) return;

  timerState.running = true;
  timerState.startTime = Date.now();

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²ï¼ˆåˆå›èµ·å‹•æ™‚ã®ã¿ï¼‰
  if (!currentSessionStartIso) {
    currentSessionStartIso = new Date().toISOString();
  }

  document.getElementById('timerPanel').classList.add('running');
  document.getElementById('timerDisplay').classList.add('running');
  document.getElementById('timerStartBtn').disabled = true;
  document.getElementById('timerStartBtn').textContent = 'â–¶ è¨ˆæ¸¬ä¸­...';
  document.getElementById('timerStopBtn').disabled = false;

  timerState.intervalId = setInterval(updateTimerDisplay, 1000);
  updateTimerDisplay();
  saveTimerState();
}

function stopTimer() {
  if (!timerState.running) return;

  timerState.elapsedTime += Date.now() - timerState.startTime;
  timerState.running = false;

  document.getElementById('timerPanel').classList.remove('running');
  document.getElementById('timerDisplay').classList.remove('running');
  document.getElementById('timerStartBtn').disabled = false;
  document.getElementById('timerStartBtn').textContent = 'â–¶ å†é–‹';
  document.getElementById('timerStopBtn').disabled = true;

  if (timerState.intervalId) {
    clearInterval(timerState.intervalId);
    timerState.intervalId = null;
  }
  updateTimerDisplay();
  saveTimerState();
}

async function resetTimer() {
  await finalizeSession();
  stopTimer();
  timerState.elapsedTime = 0;
  timerState.annotationCount = 0;
  timerState.startTime = 0;

  document.getElementById('timerStartBtn').textContent = 'â–¶ é–‹å§‹';
  updateTimerDisplay();
  saveTimerState();
}

function incrementTimerCount() {
  if (timerState.running) {
    timerState.annotationCount++;
    updateTimerDisplay();
    saveTimerState();
  }
}

// ã‚¿ã‚¤ãƒãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById('timerStartBtn').onclick = startTimer;
document.getElementById('timerStopBtn').onclick = stopTimer;
document.getElementById('timerResetBtn').onclick = function() {
  if (timerState.annotationCount > 0 || timerState.elapsedTime > 0) {
    if (confirm('ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nè¨˜éŒ²ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚')) {
      resetTimer();
    }
  } else {
    resetTimer();
  }
};

// åˆæœŸåŒ–: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒ
loadTimerState();
updateTimerDisplay();

// ===== ä½œæ¥­ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆ =====

async function openStatsFile() {
  if (!window.showOpenFilePicker) {
    showStatus("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯File System Access APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“", "error");
    return;
  }
  try {
    var handles = await window.showOpenFilePicker({
      types: [{ description: "JSON", accept: { "application/json": [".json"] } }]
    });
    statsFileHandle = handles[0];
    var file = await statsFileHandle.getFile();
    var text = await file.text();
    var data = JSON.parse(text);
    sessionLog = Array.isArray(data.sessions) ? data.sessions : [];
    document.getElementById("statsFileStatus").textContent = "âœ“ " + statsFileHandle.name;
    renderStatsModal();
  } catch (err) {
    if (err.name !== "AbortError") {
      showStatus("çµ±è¨ˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: " + err.message, "error");
    }
  }
}

async function createStatsFile() {
  if (!window.showSaveFilePicker) {
    showStatus("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯File System Access APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“", "error");
    return;
  }
  try {
    statsFileHandle = await window.showSaveFilePicker({
      suggestedName: "work_sessions.json",
      types: [{ description: "JSON", accept: { "application/json": [".json"] } }]
    });
    sessionLog = [];
    await saveSessionLog();
    document.getElementById("statsFileStatus").textContent = "âœ“ " + statsFileHandle.name;
    renderStatsModal();
  } catch (err) {
    if (err.name !== "AbortError") {
      showStatus("çµ±è¨ˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«å¤±æ•—: " + err.message, "error");
    }
  }
}

async function saveSessionLog() {
  if (!statsFileHandle) return;
  try {
    var writable = await statsFileHandle.createWritable();
    var json = JSON.stringify({ sessions: sessionLog }, null, 2);
    await writable.write(json);
    await writable.close();
  } catch (err) {
    console.error("çµ±è¨ˆãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:", err);
  }
}

async function finalizeSession() {
  var elapsed = timerState.elapsedTime;
  if (timerState.running) {
    elapsed += Date.now() - timerState.startTime;
  }
  var count = timerState.annotationCount;

  // çµŒé1ç§’æœªæº€ã‹ã¤ç™»éŒ²0ä»¶ã¯ã‚¹ã‚­ãƒƒãƒ—
  if (elapsed < 1000 && count === 0) return;
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚åˆ»ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if (!currentSessionStartIso) return;

  var now = new Date();
  var session = {
    id: "s_" + Date.now(),
    startedAt: currentSessionStartIso,
    endedAt: now.toISOString(),
    durationMs: elapsed,
    annotationCount: count,
    ratePerHour: elapsed > 0 ? parseFloat((count / (elapsed / 3600000)).toFixed(1)) : 0
  };

  sessionLog.push(session);
  await saveSessionLog();

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚åˆ»ã‚’ã‚¯ãƒªã‚¢
  currentSessionStartIso = null;
  saveTimerState();
}

function renderStatsModal() {
  var summaryEl = document.getElementById("statsSummary");
  var tableEl = document.getElementById("statsTableContainer");

  if (sessionLog.length === 0) {
    summaryEl.innerHTML = "";
    tableEl.innerHTML = "<p style='color: var(--text-secondary); font-size: 14px;'>ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    return;
  }

  // ã‚µãƒãƒªãƒ¼è¨ˆç®—
  var totalSessions = sessionLog.length;
  var totalMs = 0;
  var totalCount = 0;
  for (var i = 0; i < sessionLog.length; i++) {
    totalMs += sessionLog[i].durationMs || 0;
    totalCount += sessionLog[i].annotationCount || 0;
  }
  var totalHours = totalMs / 3600000;
  var avgRate = totalHours > 0 ? (totalCount / totalHours).toFixed(1) : "-";

  summaryEl.innerHTML =
    '<div class="stats-summary-card"><div class="stat-value">' + totalSessions + '</div><div class="stat-label">ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</div></div>' +
    '<div class="stats-summary-card"><div class="stat-value">' + formatTimerTime(totalMs) + '</div><div class="stat-label">åˆè¨ˆæ™‚é–“</div></div>' +
    '<div class="stats-summary-card"><div class="stat-value">' + totalCount + '</div><div class="stat-label">åˆè¨ˆä»¶æ•°</div></div>' +
    '<div class="stats-summary-card"><div class="stat-value">' + avgRate + '</div><div class="stat-label">å¹³å‡ ä»¶/æ™‚</div></div>';

  // ãƒ†ãƒ¼ãƒ–ãƒ«
  var html = '<table class="stats-table"><thead><tr><th>æ—¥ä»˜</th><th>æ™‚é–“å¸¯</th><th>ä½œæ¥­æ™‚é–“</th><th>ä»¶æ•°</th><th>ä»¶/æ™‚</th></tr></thead><tbody>';
  // æ–°ã—ã„é †ã«è¡¨ç¤º
  for (var j = sessionLog.length - 1; j >= 0; j--) {
    var s = sessionLog[j];
    var startDate = new Date(s.startedAt);
    var endDate = new Date(s.endedAt);
    var dateStr = (startDate.getMonth() + 1) + "/" + startDate.getDate();
    var timeStr = String(startDate.getHours()).padStart(2, "0") + ":" + String(startDate.getMinutes()).padStart(2, "0") +
      " - " + String(endDate.getHours()).padStart(2, "0") + ":" + String(endDate.getMinutes()).padStart(2, "0");
    var durStr = formatTimerTime(s.durationMs || 0);
    var rate = s.ratePerHour != null ? s.ratePerHour : "-";

    html += "<tr><td>" + dateStr + "</td><td>" + timeStr + "</td><td>" + durStr + "</td><td>" + s.annotationCount + "</td><td>" + rate + "</td></tr>";
  }
  html += "</tbody></table>";
  tableEl.innerHTML = html;
}

function showStatsModal() {
  renderStatsModal();
  document.getElementById("statsModal").classList.add("show");
}

// çµ±è¨ˆãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById("statsBtn").onclick = showStatsModal;
document.getElementById("statsOpenBtn").onclick = openStatsFile;
document.getElementById("statsCreateBtn").onclick = createStatsFile;

// ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚åˆ»ã¯loadTimerState()ã§å¾©å…ƒæ¸ˆã¿

function getTableRows() {
  return document.querySelectorAll("#annotationBody tr");
}

function clearTableSelection() {
  var rows = getTableRows();
  for (var i = 0; i < rows.length; i++) {
    rows[i].classList.remove("selected");
  }
  selectedRowIndex = -1;
  selectedAnnotationId = null;
}

function setTableSelectionByIndex(index) {
  var rows = getTableRows();
  if (rows.length === 0) {
    clearTableSelection();
    return;
  }

  if (index < 0) {
    clearTableSelection();
    return;
  }

  var clamped = Math.min(Math.max(index, 0), rows.length - 1);
  selectedRowIndex = clamped;
  selectedAnnotationId = parseInt(rows[clamped].dataset.id);

  for (var i = 0; i < rows.length; i++) {
    rows[i].classList.remove("selected");
  }
  rows[clamped].classList.add("selected");
  rows[clamped].scrollIntoView({ block: "nearest" });
}

function setTableSelectionById(id) {
  var rows = getTableRows();
  for (var i = 0; i < rows.length; i++) {
    if (parseInt(rows[i].dataset.id) === id) {
      setTableSelectionByIndex(i);
      return;
    }
  }
  clearTableSelection();
}

function restoreTableSelection() {
  var rows = getTableRows();
  if (rows.length === 0) {
    clearTableSelection();
    return;
  }

  if (selectedAnnotationId !== null) {
    for (var i = 0; i < rows.length; i++) {
      if (parseInt(rows[i].dataset.id) === selectedAnnotationId) {
        setTableSelectionByIndex(i);
        return;
      }
    }
  }

  if (selectedRowIndex >= 0) {
    setTableSelectionByIndex(selectedRowIndex);
  } else {
    clearTableSelection();
  }
}

function scrollTableBy(delta) {
  var container = document.getElementById("tableContainer");
  if (!container) return;
  var next = container.scrollTop + delta;
  container.scrollTop = Math.max(0, Math.min(next, container.scrollHeight));
}

function sortAnnotations() {
  annotations.sort(function(a, b) {
    var aVideo = (a.video_id || "").toString();
    var bVideo = (b.video_id || "").toString();
    var videoCmp = aVideo.localeCompare(bVideo, "ja");
    if (videoCmp !== 0) return videoCmp;

    var aStart = Number(a.start) || 0;
    var bStart = Number(b.start) || 0;
    if (aStart !== bStart) return aStart - bStart;

    var aEnd = Number(a.end) || 0;
    var bEnd = Number(b.end) || 0;
    if (aEnd !== bEnd) return aEnd - bEnd;

    return (Number(a.id) || 0) - (Number(b.id) || 0);
  });
}

// ===== ãƒ†ãƒ¼ãƒ–ãƒ«æç”» =====
function renderTable() {
  var tbody = document.getElementById("annotationBody");
  tbody.innerHTML = "";

  for (var i = 0; i < annotations.length; i++) {
    var a = annotations[i];
    var tr = document.createElement("tr");
    tr.dataset.id = a.id;

    if (editingId === a.id) {
      tr.classList.add("editing");
    }

    tr.innerHTML =
      "<td>" + a.id + "</td>" +
      "<td>" + escapeHtml(a.video_id) + "</td>" +
      '<td class="time-cell" data-time="' + a.start + '" data-vid="' + escapeHtml(a.video_id) + '">' + a.start.toFixed(1) + "</td>" +
      '<td class="time-cell" data-time="' + a.end + '" data-vid="' + escapeHtml(a.video_id) + '">' + a.end.toFixed(1) + "</td>" +
      '<td class="query-cell" title="' + escapeHtml(a.query) + '">' + escapeHtml(a.query) + "</td>" +
      "<td>" +
        '<button class="btn-primary btn-small edit-btn" data-id="' + a.id + '">ç·¨é›†</button> ' +
        '<button class="btn-danger btn-small delete-btn" data-id="' + a.id + '">å‰Šé™¤</button>' +
      "</td>";

    tr.onclick = function(e) {
      if (e.target && e.target.closest("button")) return;
      if (e.target && e.target.classList.contains("time-cell")) return;
      setTableSelectionById(parseInt(this.dataset.id));
    };

    tbody.appendChild(tr);
  }

  document.getElementById("annotationCount").textContent = annotations.length;

  // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  var editBtns = document.querySelectorAll(".edit-btn");
  for (var j = 0; j < editBtns.length; j++) {
    editBtns[j].onclick = function() {
      var id = parseInt(this.dataset.id);
      setTableSelectionById(id);
      editAnnotation(id);
    };
  }

  var deleteBtns = document.querySelectorAll(".delete-btn");
  for (var k = 0; k < deleteBtns.length; k++) {
    deleteBtns[k].onclick = function() {
      var id = parseInt(this.dataset.id);
      setTableSelectionById(id);
      deleteAnnotation(id);
    };
  }

  var timeCells = document.querySelectorAll(".time-cell");
  for (var t = 0; t < timeCells.length; t++) {
    timeCells[t].onclick = async function() {
      var vid = this.dataset.vid;
      var time = parseFloat(this.dataset.time);
      var rowId = parseInt(this.closest("tr").dataset.id);
      setTableSelectionById(rowId);
      if (vid !== currentVideoId) {
        if (videoFiles[vid]) {
          await switchVideo(vid);
          v.addEventListener("loadedmetadata", function onLoaded() {
            v.removeEventListener("loadedmetadata", onLoaded);
            seekToTime(time);
          });
          return;
        }
        showStatus("å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + vid + "ï¼ˆOã‚­ãƒ¼ã§ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼‰", "error");
        return;
      }
      seekToTime(time);
    };
  }

  restoreTableSelection();
}

function escapeHtml(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

// ===== ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›† =====
function editAnnotation(id) {
  var a = annotations.find(function(x) { return x.id === id; });
  if (!a) return;

  editingId = id;
  document.getElementById("editId").value = id;
  document.getElementById("editVideoId").value = a.video_id;
  document.getElementById("editStart").value = a.start;
  document.getElementById("editEnd").value = a.end;
  document.getElementById("editQuery").value = a.query;

  document.getElementById("formTitle").textContent = "ç·¨é›†ä¸­: ID " + id;
  document.getElementById("saveBtn").textContent = "æ›´æ–°";

  renderTable();
}

// ===== ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å‰Šé™¤ =====
function deleteAnnotation(id) {
  if (!confirm("ID " + id + " ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  annotations = annotations.filter(function(x) { return x.id !== id; });

  if (editingId === id) {
    clearForm();
  }

  renderTable();
  showStatus("ID " + id + " ã‚’å‰Šé™¤ã—ã¾ã—ãŸ", "success");
  autoSave(); // è‡ªå‹•ä¿å­˜
}

// ===== ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢ =====
function clearForm() {
  editingId = null;
  document.getElementById("editId").value = "";
  document.getElementById("editVideoId").value = currentVideoId;
  document.getElementById("editStart").value = "";
  document.getElementById("editEnd").value = "";
  document.getElementById("editQuery").value = "";

  document.getElementById("formTitle").textContent = "æ–°è¦ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³";
  document.getElementById("saveBtn").textContent = "è¿½åŠ ";

  renderTable();
}

document.getElementById("clearFormBtn").onclick = clearForm;

document.getElementById("sortAnnotationsBtn").onclick = function() {
  if (annotations.length === 0) return;
  sortAnnotations();
  renderTable();
  showStatus("å‹•ç”»ID â†’ é–‹å§‹æ™‚åˆ»ã§æ•´åˆ—ã—ã¾ã—ãŸ", "success");
};

// ===== ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ãƒã‚§ãƒƒã‚¯ =====
function isFormComplete() {
  var videoId = document.getElementById("editVideoId").value.trim();
  var startVal = document.getElementById("editStart").value.trim();
  var endVal = document.getElementById("editEnd").value.trim();
  var query = document.getElementById("editQuery").value.trim();
  return videoId !== "" && startVal !== "" && endVal !== "" && query !== "";
}

// ===== ä¿å­˜ =====
document.getElementById("saveBtn").onclick = function() {
  var videoId = document.getElementById("editVideoId").value.trim();
  var startVal = document.getElementById("editStart").value.trim();
  var endVal = document.getElementById("editEnd").value.trim();
  var query = normalizeQuotes(document.getElementById("editQuery").value.trim());

  if (!videoId) {
    showStatus("å‹•ç”»ã‚’é¸æŠã—ã¦ãã ã•ã„", "error");
    return;
  }

  if (startVal === "" || endVal === "" || query === "") {
    showStatus("start, end, query ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
    return;
  }

  var start = parseFloat(startVal) || 0;
  var end = parseFloat(endVal) || 0;

  if (editingId !== null) {
    // æ›´æ–°
    var a = annotations.find(function(x) { return x.id === editingId; });
    if (a) {
      a.video_id = videoId;
      a.start = start;
      a.end = end;
      a.query = query;
      showStatus("ID " + editingId + " ã‚’æ›´æ–°ã—ã¾ã—ãŸ", "success");
    }
  } else {
    // æ–°è¦è¿½åŠ 
    var maxId = 0;
    for (var i = 0; i < annotations.length; i++) {
      if (annotations[i].id > maxId) maxId = annotations[i].id;
    }

    var newId = maxId + 1;
    annotations.push({
      id: newId,
      video_id: videoId,
      start: start,
      end: end,
      query: query
    });
    showStatus("ID " + newId + " ã‚’è¿½åŠ ã—ã¾ã—ãŸ", "success");
    incrementTimerCount(); // ã‚¿ã‚¤ãƒãƒ¼ã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ 
    localStorage.setItem("lastAnnotatedVideoId", videoId);
  }

  clearForm();
  autoSave(); // è‡ªå‹•ä¿å­˜

  // è¿½åŠ ã—ãŸã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
  if (typeof newId !== "undefined") {
    setTableSelectionById(newId);
  }

  // ä¸€è¦§ã‚’æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  var tc = document.getElementById("tableContainer");
  if (tc) tc.scrollTop = tc.scrollHeight;
};

function normalizeQuotes(s) {
  return s.replace(/[\u2018\u2019\u201A\u201B]/g, "'").replace(/[\u201C\u201D\u201E\u201F]/g, '"');
}

// ===== å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å…¥åŠ›æ¸ˆã¿ãªã‚‰è‡ªå‹•è¿½åŠ  =====
function tryAutoAdd() {
  if (editingId !== null) return; // ç·¨é›†ä¸­ã¯è‡ªå‹•è¿½åŠ ã—ãªã„
  if (isFormComplete()) {
    document.getElementById("saveBtn").click();
  }
}

// ===== ç¾åœ¨æ™‚åˆ»ã‚»ãƒƒãƒˆ =====
document.getElementById("setStartBtn").onclick = function() {
  document.getElementById("editStart").value = formatTimeForCopy(v.currentTime);
  tryAutoAdd();
};

document.getElementById("setEndBtn").onclick = function() {
  document.getElementById("editEnd").value = formatTimeForCopy(v.currentTime);
  tryAutoAdd();
};

// ===== ã‚ªãƒ¼ãƒˆã‚µã‚¸ã‚§ã‚¹ãƒˆ =====
var queryInput = document.getElementById("editQuery");
var suggestionsBox = document.getElementById("suggestions");
var selectedIndex = -1;

function getUniqueQueries() {
  var seen = {};
  var unique = [];
  for (var i = 0; i < annotations.length; i++) {
    var q = (annotations[i].query || "").trim();
    if (q && !seen[q]) {
      seen[q] = true;
      unique.push(q);
    }
  }
  return unique.sort();
}

function showSuggestions(input) {
  var queries = getUniqueQueries();
  var inputTrimmed = input.trim();
  var matches = [];

  if (inputTrimmed.length > 0) {
    var words = inputTrimmed.toLowerCase().split(/\s+/);
    for (var i = 0; i < queries.length; i++) {
      var qLower = queries[i].toLowerCase();
      var allMatch = true;
      for (var w = 0; w < words.length; w++) {
        if (words[w] && qLower.indexOf(words[w]) === -1) {
          allMatch = false;
          break;
        }
      }
      if (allMatch) {
        matches.push(queries[i]);
      }
    }
  }

  suggestionsBox.innerHTML = "";
  selectedIndex = -1;

  if (matches.length === 0) {
    suggestionsBox.classList.remove("show");
    return;
  }

  for (var j = 0; j < matches.length && j < 10; j++) {
    var div = document.createElement("div");
    div.className = "suggestion-item";
    div.textContent = matches[j];
    div.dataset.query = matches[j];
    div.onclick = function() {
      queryInput.value = this.dataset.query;
      suggestionsBox.classList.remove("show");
      tryAutoAdd();
    };
    suggestionsBox.appendChild(div);
  }

  suggestionsBox.classList.add("show");
}

queryInput.addEventListener("input", function() {
  showSuggestions(this.value);
});

queryInput.addEventListener("focus", function() {
  if (this.value.length > 0) {
    showSuggestions(this.value);
  }
});

queryInput.addEventListener("keydown", function(e) {
  var items = suggestionsBox.querySelectorAll(".suggestion-item");

  if (e.key === "ArrowDown" && items.length > 0) {
    e.preventDefault();
    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
    updateSelection(items);
  } else if (e.key === "ArrowUp" && items.length > 0) {
    e.preventDefault();
    selectedIndex = Math.max(selectedIndex - 1, -1);
    updateSelection(items);
  } else if (e.key === "Enter") {
    e.preventDefault();
    if (selectedIndex >= 0 && items.length > 0) {
      queryInput.value = items[selectedIndex].dataset.query;
    }
    suggestionsBox.classList.remove("show");
    exitInsertMode();
  } else if (e.key === "Escape") {
    suggestionsBox.classList.remove("show");
  }
});

function updateSelection(items) {
  for (var i = 0; i < items.length; i++) {
    items[i].classList.remove("selected");
  }
  if (selectedIndex >= 0 && selectedIndex < items.length) {
    items[selectedIndex].classList.add("selected");
    items[selectedIndex].scrollIntoView({ block: "nearest" });
  }
}

document.addEventListener("click", function(e) {
  if (!suggestionsBox.contains(e.target) && e.target !== queryInput) {
    suggestionsBox.classList.remove("show");
  }
});

// ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º =====
function showStatus(msg, type) {
  var el = document.getElementById("status");
  el.textContent = msg;
  el.className = type || "";

  setTimeout(function() {
    el.textContent = "";
    el.className = "";
  }, 3000);
}

// ===== åˆæœŸåŒ–: CSVè‡ªå‹•èª­ã¿è¾¼ã¿ =====
window.onload = function() {
  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ç¢ºèª
  var backup = getBackupFromLocalStorage();
  var backupTimestamp = localStorage.getItem(BACKUP_TIMESTAMP_KEY);

  if (backup && backup.annotations && backup.annotations.length > 0) {
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚‹å ´åˆã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    var backupInfo = document.getElementById("backupInfo");
    backupInfo.innerHTML = "<strong>" + backup.annotations.length + "ä»¶</strong>ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³<br>ä¿å­˜æ—¥æ™‚: " + backupTimestamp;

    document.getElementById("backupModal").classList.add("show");

    document.getElementById("restoreBackupBtn").onclick = function() {
      restoreFromBackup();
      document.getElementById("backupModal").classList.remove("show");
      document.removeEventListener("keydown", backupModalKeyHandler);
    };

    document.getElementById("ignoreBackupBtn").onclick = function() {
      document.getElementById("backupModal").classList.remove("show");
      document.removeEventListener("keydown", backupModalKeyHandler);
      clearBackup();
      // CSVã‚’èª­ã¿è¾¼ã‚€
      loadCsvFromServer();
    };

    function backupModalKeyHandler(e) {
      if (!document.getElementById("backupModal").classList.contains("show")) return;
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("restoreBackupBtn").click();
        document.removeEventListener("keydown", backupModalKeyHandler);
      } else if (e.key === "Escape") {
        e.preventDefault();
        document.getElementById("ignoreBackupBtn").click();
        document.removeEventListener("keydown", backupModalKeyHandler);
      }
    }
    document.addEventListener("keydown", backupModalKeyHandler);
  } else {
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒãªã„å ´åˆã€é€šå¸¸é€šã‚ŠCSVã‚’èª­ã¿è¾¼ã‚€
    loadCsvFromServer();
  }

  updateBackupStatus();

  // å‹•ç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
  openVideoFolder();
};

function loadCsvFromServer() {
  fetch("jichi2507_rule.csv?t=" + Date.now())
    .then(function(res) {
      if (!res.ok) throw new Error("CSV not found");
      return res.text();
    })
    .then(function(csv) {
      parseCsv(csv);
      showStatus("CSVè‡ªå‹•èª­ã¿è¾¼ã¿å®Œäº† (" + annotations.length + "ä»¶)", "success");
    })
    .catch(function(err) {
      showStatus("CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚", "error");
    });
}

// ===== ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ =====
document.getElementById("shortcutHelpBtn").onclick = function() {
  document.getElementById("shortcutModal").classList.add("show");
};

document.getElementById("shortcutModal").onclick = function(e) {
  if (e.target === this) {
    this.classList.remove("show");
  }
};

// å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
// ã‚¤ãƒ³ã‚µãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¯ã‚¨ãƒªå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼‰
var insertMode = false;

function isInputFocused() {
  var el = document.activeElement;
  if (!el) return false;
  return el.id === "editQuery" || el.id === "videoSearchInput";
}

function enterInsertMode() {
  insertMode = true;
  var queryInput = document.getElementById("editQuery");
  queryInput.focus();
  updateInsertModeIndicator();
}

function exitInsertMode() {
  insertMode = false;
  document.getElementById("editQuery").blur();
  document.activeElement.blur();
  updateInsertModeIndicator();
  tryAutoAdd();
}

function updateInsertModeIndicator() {
  var indicator = document.getElementById("insertModeIndicator");
  if (insertMode) {
    indicator.classList.add("active");
    indicator.textContent = "ğŸ“ INSERT MODE (Escã§çµ‚äº†)";
  } else {
    indicator.classList.remove("active");
    indicator.textContent = "[I] ã§å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰";
  }
}

// ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ãƒšãƒ¼ã‚¹ãƒˆï¼ˆClipboard APIï¼‰
async function pasteToQuery() {
  var queryInput = document.getElementById("editQuery");
  queryInput.focus();
  enterInsertMode();

  if (navigator.clipboard && navigator.clipboard.readText) {
    try {
      var text = await navigator.clipboard.readText();
      if (text) {
        insertTextToQuery(text);
        showStatus("ãƒšãƒ¼ã‚¹ãƒˆã—ã¾ã—ãŸ", "success");
        // ãƒšãƒ¼ã‚¹ãƒˆå¾Œã¯ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã™
        exitInsertMode();
        tryAutoAdd();
      }
    } catch (err) {
      showStatus("Ctrl+V ã§ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„", "error");
    }
  } else {
    showStatus("Ctrl+V ã§ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„", "error");
  }
}

function insertTextToQuery(text) {
  var queryInput = document.getElementById("editQuery");
  queryInput.value = text;
  var endPos = text.length;
  queryInput.selectionStart = queryInput.selectionEnd = endPos;
}

// å…¨ã¦ã®ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å¾Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã™
document.addEventListener("click", function(e) {
  var target = e.target;
  if (target.tagName === "BUTTON" || target.tagName === "INPUT" && target.type !== "text" && target.type !== "number" && target.id !== "editQuery") {
    // ã‚¯ã‚¨ãƒªä»¥å¤–ã®å…¥åŠ›è¦ç´ ã‚„ãƒœã‚¿ãƒ³ã¯ã‚¯ãƒªãƒƒã‚¯å¾Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã™
    setTimeout(function() {
      if (document.activeElement && document.activeElement.id !== "editQuery") {
        document.activeElement.blur();
      }
    }, 10);
  }
});

// ã‚¯ã‚¨ãƒªãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹/ãƒ–ãƒ©ãƒ¼ã§ã‚¤ãƒ³ã‚µãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
document.getElementById("editQuery").addEventListener("focus", function() {
  insertMode = true;
  updateInsertModeIndicator();
});

document.getElementById("editQuery").addEventListener("blur", function() {
  insertMode = false;
  updateInsertModeIndicator();
});

// Escapeã§ã‚¤ãƒ³ã‚µãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰çµ‚äº†
document.getElementById("editQuery").addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    e.preventDefault();
    exitInsertMode();
  }
});

// ãƒšãƒ¼ã‚¹ãƒˆãƒœã‚¿ãƒ³
document.getElementById("pasteBtn").onclick = function() {
  pasteToQuery();
  this.blur();
};

document.addEventListener("keydown", function(e) {
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯Escã§é–‰ã˜ã‚‹
  var modal = document.getElementById("shortcutModal");
  var statsModal = document.getElementById("statsModal");
  if (statsModal.classList.contains("show")) {
    if (e.key === "Escape") {
      statsModal.classList.remove("show");
    }
    return;
  }
  if (modal.classList.contains("show")) {
    if (e.key === "Escape") {
      modal.classList.remove("show");
    }
    return;
  }

  // Ctrl+S: æ‰‹å‹•ä¿å­˜
  if (e.ctrlKey && e.code === "KeyS") {
    e.preventDefault();
    saveToCsv(true);
    return;
  }

  // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã¯ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç„¡åŠ¹
  if (isInputFocused()) return;

  var code = e.code;

  switch (code) {
    // å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    case "Space": // Space: å†ç”Ÿ/ä¸€æ™‚åœæ­¢
      e.preventDefault();
      document.getElementById("btnPlayPause").click();
      break;
    case "KeyF": // F: é¸æŠä¸­ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç·¨é›†
      if (selectedAnnotationId !== null) {
        e.preventDefault();
        editAnnotation(selectedAnnotationId);
      }
      break;
    case "Comma": // ,: ãƒŸãƒ¥ãƒ¼ãƒˆ
      e.preventDefault();
      document.getElementById("muteBtn").click();
      break;
    case "ArrowUp": // â†‘: ä¸€è¦§ã®å‰ã®è¡Œã‚’é¸æŠ
      e.preventDefault();
      setTableSelectionByIndex(selectedRowIndex - 1);
      break;
    case "ArrowDown": // â†“: ä¸€è¦§ã®æ¬¡ã®è¡Œã‚’é¸æŠ
      e.preventDefault();
      setTableSelectionByIndex(selectedRowIndex + 1);
      break;
    case "BracketLeft": // [: éŸ³é‡-10%
      if (e.key === "[") {
        e.preventDefault();
        adjustVolume(-10);
      }
      break;
    case "BracketRight": // ]: éŸ³é‡+10%
    case "Backslash": // JISã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¯¾å¿œ
      if (e.key === "]") {
        e.preventDefault();
        adjustVolume(10);
      } else if (e.key === "[") {
        e.preventDefault();
        adjustVolume(-10);
      }
      break;

    // ã‚·ãƒ¼ã‚¯
    case "KeyN": // N: -10ç§’
      e.preventDefault();
      seekBy(-10, false);
      break;
    case "KeyH": // H: -1ç§’
      e.preventDefault();
      seekBy(-1);
      break;
    case "KeyJ": // J: -0.1ç§’
      e.preventDefault();
      seekBy(-0.1);
      break;
    case "KeyK": // K: +0.1ç§’
      e.preventDefault();
      seekBy(0.1);
      break;
    case "KeyL": // L: +1ç§’
      e.preventDefault();
      seekBy(1);
      break;
    case "KeyM": // M: +10ç§’
      e.preventDefault();
      seekBy(10, false);
      break;

    // ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
    case "KeyS": // S: Startæ™‚åˆ»ã‚»ãƒƒãƒˆ
      e.preventDefault();
      document.getElementById("setStartBtn").click();
      break;
    case "KeyE": // E: Endæ™‚åˆ»ã‚»ãƒƒãƒˆ
      e.preventDefault();
      document.getElementById("setEndBtn").click();
      break;

    case "KeyD": // D: ãƒ†ãƒ¼ãƒåˆ‡æ›¿
      e.preventDefault();
      toggleTheme();
      break;

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ•ã‚©ãƒ¼ãƒ æ“ä½œ
    case "KeyO": // O: å‹•ç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã
      e.preventDefault();
      openVideoFolder();
      break;
    case "KeyW": // W: æ¬¡ã®å‹•ç”»
      e.preventDefault();
      navigateVideo(1);
      break;
    case "KeyQ": // Q: å‰ã®å‹•ç”»
      e.preventDefault();
      navigateVideo(-1);
      break;
    case "Slash":
      if (e.shiftKey) {
        // ?: ãƒ˜ãƒ«ãƒ—
        e.preventDefault();
        document.getElementById("shortcutModal").classList.add("show");
      } else {
        // /: å‹•ç”»æ¤œç´¢
        e.preventDefault();
        var si = document.getElementById("videoSearchInput");
        if (si && document.getElementById("videoSelectorContainer").style.display !== "none") {
          si.focus();
        }
      }
      break;
    case "Enter": // Enter: ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ /æ›´æ–°
      e.preventDefault();
      document.getElementById("saveBtn").click();
      break;
    case "KeyI": // I: ã‚¤ãƒ³ã‚µãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¯ã‚¨ãƒªå…¥åŠ›ï¼‰
      e.preventDefault();
      enterInsertMode();
      break;
    case "KeyV": // V: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ãƒšãƒ¼ã‚¹ãƒˆ
      e.preventDefault();
      pasteToQuery();
      break;
    case "KeyC": // C: ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
      e.preventDefault();
      clearForm();
      break;

    // ã‚¿ã‚¤ãƒãƒ¼æ“ä½œ
    case "KeyT": // T: ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹/åœæ­¢ãƒˆã‚°ãƒ«
      e.preventDefault();
      if (timerState.running) {
        stopTimer();
      } else {
        startTimer();
      }
      break;
    case "KeyY": // Y: ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
      e.preventDefault();
      if (timerState.annotationCount > 0 || timerState.elapsedTime > 0) {
        if (confirm('ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          resetTimer();
        }
      }
      break;
    case "KeyU": // U: çµ±è¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«
      e.preventDefault();
      showStatsModal();
      break;
    case "PageUp": // PageUp: ä¸€è¦§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸Š
      var tableUp = document.getElementById("tableContainer");
      if (tableUp) {
        e.preventDefault();
        scrollTableBy(-tableUp.clientHeight * 0.9);
      }
      break;
    case "PageDown": // PageDown: ä¸€è¦§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸‹
      var tableDown = document.getElementById("tableContainer");
      if (tableDown) {
        e.preventDefault();
        scrollTableBy(tableDown.clientHeight * 0.9);
      }
      break;
    case "Home": // Home: ä¸€è¦§å…ˆé ­
      e.preventDefault();
      setTableSelectionByIndex(0);
      break;
    case "End": // End: ä¸€è¦§æœ«å°¾
      e.preventDefault();
      setTableSelectionByIndex(getTableRows().length - 1);
      break;
    case "KeyG":
      // G: é¸æŠä¸­ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®æ™‚é–“ã«ã‚¸ãƒ£ãƒ³ãƒ—
      if (selectedAnnotationId !== null) {
        e.preventDefault();
        jumpToAnnotationTime(selectedAnnotationId);
      }
      break;
    case "Delete": // Delete: ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å‰Šé™¤
      if (selectedAnnotationId !== null) {
        e.preventDefault();
        deleteAnnotation(selectedAnnotationId);
      }
      break;
  }

});

// ===== ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ =====
(function() {
  var resizeHandle = document.getElementById("resizeHandle");
  var leftColumn = document.getElementById("leftColumn");
  var rightColumn = document.getElementById("rightColumn");
  var mainGrid = document.getElementById("mainGrid");

  if (!resizeHandle || !leftColumn || !rightColumn || !mainGrid) return;

  var isDragging = false;
  var startX = 0;
  var startLeftWidth = 0;

  // ä¿å­˜ã•ã‚ŒãŸå¹…ã‚’å¾©å…ƒ
  var savedLeftWidth = localStorage.getItem("columnLeftWidth");
  if (savedLeftWidth && window.innerWidth >= 1024) {
    var percent = parseFloat(savedLeftWidth);
    if (percent >= 20 && percent <= 80) {
      leftColumn.style.flex = "0 0 " + percent + "%";
      rightColumn.style.flex = "0 0 " + (100 - percent - 2) + "%";
    }
  }

  function onMouseDown(e) {
    if (window.innerWidth < 1024) return;

    isDragging = true;
    startX = e.clientX || e.touches[0].clientX;
    startLeftWidth = leftColumn.offsetWidth;

    resizeHandle.classList.add("dragging");
    document.body.style.cursor = "col-resize";
    document.body.style.userSelect = "none";

    e.preventDefault();
  }

  function onMouseMove(e) {
    if (!isDragging) return;

    var clientX = e.clientX || (e.touches && e.touches[0].clientX);
    if (!clientX) return;

    var delta = clientX - startX;
    var containerWidth = mainGrid.offsetWidth;
    var newLeftWidth = startLeftWidth + delta;

    // æœ€å°ãƒ»æœ€å¤§å¹…ã®åˆ¶é™ï¼ˆ20%ã€œ80%ï¼‰
    var minWidth = containerWidth * 0.2;
    var maxWidth = containerWidth * 0.8;

    if (newLeftWidth < minWidth) newLeftWidth = minWidth;
    if (newLeftWidth > maxWidth) newLeftWidth = maxWidth;

    var leftPercent = (newLeftWidth / containerWidth) * 100;
    var rightPercent = 100 - leftPercent - 2; // 2% for handle and gaps

    leftColumn.style.flex = "0 0 " + leftPercent + "%";
    rightColumn.style.flex = "0 0 " + rightPercent + "%";
  }

  function onMouseUp() {
    if (!isDragging) return;

    isDragging = false;
    resizeHandle.classList.remove("dragging");
    document.body.style.cursor = "";
    document.body.style.userSelect = "";

    // å¹…ã‚’ä¿å­˜
    var containerWidth = mainGrid.offsetWidth;
    var leftPercent = (leftColumn.offsetWidth / containerWidth) * 100;
    localStorage.setItem("columnLeftWidth", leftPercent.toFixed(1));
  }

  // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
  resizeHandle.addEventListener("mousedown", onMouseDown);
  document.addEventListener("mousemove", onMouseMove);
  document.addEventListener("mouseup", onMouseUp);

  // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
  resizeHandle.addEventListener("touchstart", onMouseDown, { passive: false });
  document.addEventListener("touchmove", onMouseMove, { passive: false });
  document.addEventListener("touchend", onMouseUp);

  // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«ãƒªã‚»ãƒƒãƒˆ
  var resizeTimeout;
  window.addEventListener("resize", function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      if (window.innerWidth < 1024) {
        leftColumn.style.flex = "";
        rightColumn.style.flex = "";
      } else {
        // ä¿å­˜ã•ã‚ŒãŸå¹…ã‚’å†é©ç”¨
        var saved = localStorage.getItem("columnLeftWidth");
        if (saved) {
          var percent = parseFloat(saved);
          if (percent >= 20 && percent <= 80) {
            leftColumn.style.flex = "0 0 " + percent + "%";
            rightColumn.style.flex = "0 0 " + (100 - percent - 2) + "%";
          }
        }
      }
    }, 100);
  });
})();
</script>

</div>
</body>
</html>
